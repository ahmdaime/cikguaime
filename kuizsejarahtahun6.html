<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kuiz Interaktif Sejarah Tahun 6</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            min-height: 100%;
            padding: 20px;
            color: #333;
        }

        html {
            height: 100%;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            padding: 30px;
            position: relative;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #667eea;
        }

        .header h1 {
            color: #667eea;
            font-size: 2em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .header p {
            color: #666;
            font-size: 1.1em;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
            font-size: 1em;
        }

        input[type="text"] {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.3);
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 15px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            width: 100%;
            margin-top: 10px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-small {
            padding: 10px 20px;
            font-size: 0.9em;
            width: auto;
            display: inline-block;
        }

        .question-container {
            margin-bottom: 30px;
        }

        .question-header {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .question-number {
            color: #667eea;
            font-weight: 700;
            font-size: 1.1em;
        }

        .question-text {
            font-size: 1.2em;
            color: #333;
            margin-top: 10px;
            line-height: 1.6;
        }

        .choices {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .choice {
            background: #f8f9fa;
            border: 2px solid #ddd;
            padding: 15px 20px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1em;
        }

        .choice:hover {
            background: #e9ecef;
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .choice.selected {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .match-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .match-column h4 {
            margin-bottom: 15px;
            color: #667eea;
            font-weight: 700;
        }

        .match-item {
            background: #f8f9fa;
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border: 2px solid #ddd;
        }

        .match-select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            margin-top: 8px;
        }

        .progress-bar {
            background: #e9ecef;
            height: 8px;
            border-radius: 10px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(90deg, #667eea, #764ba2, #f093fb);
            height: 100%;
            transition: width 0.3s;
            box-shadow: 0 2px 10px rgba(102, 126, 234, 0.3);
        }

        .result-card {
            text-align: center;
            padding: 40px 20px;
        }

        .score-display {
            font-size: 4em;
            background: linear-gradient(135deg, #667eea, #764ba2, #f093fb);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700;
            margin: 20px 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .percentage {
            font-size: 2em;
            color: #666;
            margin-bottom: 20px;
        }

        .result-message {
            font-size: 1.3em;
            color: #555;
            margin-bottom: 30px;
        }

        .review-section {
            margin-top: 30px;
            text-align: left;
        }

        .review-question {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border-left: 5px solid #667eea;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .review-answer {
            margin-top: 15px;
            padding: 10px;
            border-radius: 8px;
        }

        .correct-answer {
            background: #d4edda;
            border: 2px solid #28a745;
        }

        .wrong-answer {
            background: #f8d7da;
            border: 2px solid #dc3545;
        }

        .answer-label {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #ddd;
        }

        .tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
        }

        .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .leaderboard-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }

        .leaderboard-table td {
            padding: 12px;
            border-bottom: 1px solid #ddd;
        }

        .leaderboard-table tr:hover {
            background: #f8f9fa;
        }

        .rank-badge {
            display: inline-block;
            width: 30px;
            height: 30px;
            line-height: 30px;
            text-align: center;
            border-radius: 50%;
            font-weight: 700;
            color: white;
        }

        .rank-1 { background: #FFD700; color: #333; }
        .rank-2 { background: #C0C0C0; color: #333; }
        .rank-3 { background: #CD7F32; color: white; }
        .rank-other { background: #6c757d; }

        .watermark {
            position: fixed;
            bottom: 20px;
            right: 20px;
            opacity: 0.8;
            font-size: 0.9em;
            color: white;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.9), rgba(118, 75, 162, 0.9));
            padding: 8px 15px;
            border-radius: 25px;
            text-decoration: none;
            transition: all 0.3s;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .watermark:hover {
            opacity: 1;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #333;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 2000;
            animation: slideIn 0.3s ease-out;
        }

        .toast.success { background: #28a745; }
        .toast.error { background: #dc3545; }
        .toast.info { background: #17a2b8; }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .hidden {
            display: none;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .error-message {
            color: #dc3545;
            font-size: 0.9em;
            margin-top: 5px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }

            .header h1 {
                font-size: 1.5em;
            }

            .score-display {
                font-size: 3em;
            }

            .match-container {
                grid-template-columns: 1fr;
            }

            .leaderboard-table {
                font-size: 0.9em;
            }

            .leaderboard-table th,
            .leaderboard-table td {
                padding: 8px 5px;
            }

            .watermark {
                font-size: 0.8em;
                padding: 6px 12px;
                bottom: 10px;
                right: 10px;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 10px;
            }

            .container {
                padding: 15px;
                border-radius: 15px;
            }

            .header h1 {
                font-size: 1.3em;
            }

            .btn {
                padding: 12px 20px;
                font-size: 1em;
            }

            .leaderboard-table th:nth-child(n+4),
            .leaderboard-table td:nth-child(n+4) {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="container" id="app"></div>
    <a href="https://www.cikguaime.com/" target="_blank" rel="noopener noreferrer" class="watermark">CikguAime</a>

    <script>
        // ===== KONFIGURASI =====
        const CONFIG = {
            QUIZ_ID: "SEJARAH_TAHUN6_2024",
            SCRIPT_URL: "https://script.google.com/macros/s/AKfycbw0KvthhUv9QrqfZfBofpdVhKfzJnPZg8BSJp8tsWSAuFCAT2aE2gCnZ_qSHjLjuIim/exec",
            TIMEZONE: "Asia/Kuala_Lumpur",
            LEADERBOARD_LIMIT: 50,
            RANDOMIZE_QUESTIONS: true,
            RANDOMIZE_CHOICES: true,
            ENABLE_ANTI_CHEAT: true,
            ADMIN_PASSWORD: "admin123" // Tukar password ini!
        };

        // ===== SOALAN KUIZ =====
        let QUESTIONS = [
            {
                type: "mcq",
                question: "Siapakah yang digelar sebagai 'Bapa Kemerdekaan Malaysia'?",
                choices: ["Tunku Abdul Rahman", "Tun Abdul Razak", "Tun Hussein Onn", "Tun Dr. Mahathir"],
                correct: 0
            },
            {
                type: "mcq",
                question: "Pada tahun berapakah Malaysia mencapai kemerdekaan?",
                choices: ["1955", "1957", "1963", "1965"],
                correct: 1
            },
            {
                type: "truefalse",
                question: "Perjanjian Persekutuan Tanah Melayu 1948 telah memberikan kemerdekaan kepada Tanah Melayu.",
                correct: false
            },
            {
                type: "truefalse",
                question: "Rukun Negara diisytiharkan pada 31 Ogos 1970.",
                correct: true
            },
            {
                type: "mcq",
                question: "Apakah nama perjanjian yang membawa kepada pembentukan Malaysia pada 1963?",
                choices: ["Perjanjian London", "Perjanjian Pangkor", "Perjanjian Malaysia", "Perjanjian Persekutuan"],
                correct: 2
            },
            {
                type: "match",
                question: "Padankan tokoh dengan peranan mereka:",
                pairs: [
                    { left: "Tunku Abdul Rahman", right: "Perdana Menteri Pertama" },
                    { left: "Tun Abdul Razak", right: "Bapa Pembangunan" },
                    { left: "Tun Dr. Ismail", right: "Timbalan Perdana Menteri" }
                ]
            },
            {
                type: "mcq",
                question: "Apakah maksud 'Merdeka'?",
                choices: ["Kebebasan", "Kemajuan", "Keamanan", "Kesatuan"],
                correct: 0
            },
            {
                type: "truefalse",
                question: "Sabah dan Sarawak menyertai Malaysia pada tahun yang sama dengan kemerdekaan Tanah Melayu.",
                correct: false
            },
            {
                type: "mcq",
                question: "Di manakah kemerdekaan Tanah Melayu diisytiharkan?",
                choices: ["Stadium Merdeka", "Istana Negara", "Dataran Merdeka", "Parlimen"],
                correct: 2
            },
            {
                type: "match",
                question: "Padankan negeri dengan tahun penyertaan dalam Malaysia:",
                pairs: [
                    { left: "Malaya", right: "1957" },
                    { left: "Sabah", right: "1963" },
                    { left: "Sarawak", right: "1963" }
                ]
            }
        ];

        // ===== STATE APLIKASI =====
        let state = {
            screen: 'intro',
            studentInfo: {},
            questions: [],
            currentQuestion: 0,
            answers: [],
            startTime: null,
            endTime: null,
            score: 0,
            submitted: false,
            isAdmin: false
        };

        // ===== FUNGSI UTILITI =====
        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        function formatDuration(ms) {
            const seconds = Math.floor(ms / 1000);
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes}m ${remainingSeconds}s`;
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        function getISODateInTimezone() {
            const now = new Date();
            const offset = 8 * 60;
            const localTime = now.getTime();
            const localOffset = now.getTimezoneOffset() * 60000;
            const utc = localTime + localOffset;
            const targetTime = utc + (offset * 60000);
            return new Date(targetTime).toISOString();
        }

        // ===== ANTI-PENIRUAN =====
        function installAntiCheat() {
            if (!CONFIG.ENABLE_ANTI_CHEAT) return;

            document.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                return false;
            });

            document.addEventListener('keydown', (e) => {
                if (
                    e.key === 'F12' ||
                    (e.ctrlKey && e.shiftKey && e.key === 'I') ||
                    (e.ctrlKey && e.shiftKey && e.key === 'J') ||
                    (e.ctrlKey && e.key === 'U')
                ) {
                    e.preventDefault();
                    return false;
                }
            });
        }

        // ===== RENDER INTRO =====
        function renderIntro() {
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="header">
                    <h1>📚 Kuiz Interaktif Sejarah</h1>
                    <p>Tahun 6</p>
                </div>
                <form id="introForm">
                    <div class="form-group">
                        <label for="nama">Nama Penuh: *</label>
                        <input type="text" id="nama" required minlength="2" maxlength="30" placeholder="Masukkan nama anda">
                        <div class="error-message hidden" id="namaError">Nama mesti antara 2-30 aksara</div>
                    </div>
                    <div class="form-group">
                        <label for="kelas">Kelas:</label>
                        <input type="text" id="kelas" placeholder="Contoh: 6 Amanah">
                    </div>
                    <div class="form-group">
                        <label for="sekolah">Sekolah:</label>
                        <input type="text" id="sekolah" placeholder="Nama sekolah anda">
                    </div>
                    <button type="submit" class="btn">Mula Kuiz</button>
                    <button type="button" class="btn btn-secondary" id="adminBtn">Admin Panel</button>
                </form>
            `;

            document.getElementById('introForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const nama = document.getElementById('nama').value.trim();
                const kelas = document.getElementById('kelas').value.trim();
                const sekolah = document.getElementById('sekolah').value.trim();

                if (nama.length < 2 || nama.length > 30) {
                    document.getElementById('namaError').classList.remove('hidden');
                    return;
                }

                state.studentInfo = { nama, kelas, sekolah };
                startQuiz();
            });

            document.getElementById('adminBtn').addEventListener('click', showAdminLogin);
        }

        // ===== ADMIN LOGIN =====
        function showAdminLogin() {
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="header">
                    <h1>🔐 Admin Panel</h1>
                    <p>Sila masukkan password</p>
                </div>
                <form id="adminLoginForm">
                    <div class="form-group">
                        <label for="adminPassword">Password Admin:</label>
                        <input type="password" id="adminPassword" required placeholder="Masukkan password">
                        <div class="error-message hidden" id="passwordError">Password salah!</div>
                    </div>
                    <button type="submit" class="btn">Log Masuk</button>
                    <button type="button" class="btn btn-secondary" id="backToIntroBtn">Kembali</button>
                </form>
            `;

            document.getElementById('adminLoginForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const password = document.getElementById('adminPassword').value;

                if (password === CONFIG.ADMIN_PASSWORD) {
                    state.isAdmin = true;
                    showAdminPanel();
                } else {
                    document.getElementById('passwordError').classList.remove('hidden');
                }
            });

            document.getElementById('backToIntroBtn').addEventListener('click', () => {
                renderIntro();
            });
        }

        // ===== ADMIN PANEL =====
        function showAdminPanel() {
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="header">
                    <h1>⚙️ Admin Panel</h1>
                    <p>Sistem Pengurusan Kuiz</p>
                </div>
                
                <div style="margin-bottom: 30px; padding: 20px; background: #f8f9fa; border-radius: 15px;">
                    <h3 style="color: #667eea; margin-bottom: 15px;">📊 Statistik Sistem</h3>
                    <div id="adminStats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div style="background: white; padding: 15px; border-radius: 10px; border: 2px solid #667eea;">
                            <div style="font-size: 0.9em; color: #666;">Quiz ID</div>
                            <div style="font-size: 1.2em; font-weight: 700; color: #667eea;">${CONFIG.QUIZ_ID}</div>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 10px; border: 2px solid #28a745;">
                            <div style="font-size: 0.9em; color: #666;">Status Sambungan</div>
                            <div id="connectionStatus" style="font-size: 1.2em; font-weight: 700; color: #666;">Checking...</div>
                        </div>
                    </div>
                </div>

                <div style="margin-bottom: 20px;">
                    <h3 style="color: #667eea; margin-bottom: 15px;">🧪 Ujian Sistem</h3>
                    
                    <div style="background: #fff3cd; border: 2px solid #ffc107; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                        <h4 style="color: #856404; margin-bottom: 10px;">Test 1: Sambungan ke Google Apps Script</h4>
                        <p style="color: #856404; font-size: 0.9em; margin-bottom: 10px;">Ujian ini akan semak sama ada sistem boleh berhubung dengan Google Sheets.</p>
                        <button class="btn btn-small" id="testConnectionBtn">🔌 Uji Sambungan</button>
                        <div id="testConnectionResult" style="margin-top: 10px; font-weight: 600;"></div>
                    </div>

                    <div style="background: #d1ecf1; border: 2px solid #17a2b8; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                        <h4 style="color: #0c5460; margin-bottom: 10px;">Test 2: Hantar Data Sampel</h4>
                        <p style="color: #0c5460; font-size: 0.9em; margin-bottom: 10px;">Ujian ini akan menghantar data sampel ke Google Sheets untuk memastikan sistem berfungsi.</p>
                        <button class="btn btn-small" id="testSubmitBtn">📤 Hantar Data Test</button>
                        <div id="testSubmitResult" style="margin-top: 10px; font-weight: 600;"></div>
                    </div>

                    <div style="background: #d4edda; border: 2px solid #28a745; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                        <h4 style="color: #155724; margin-bottom: 10px;">Test 3: Baca Data Leaderboard</h4>
                        <p style="color: #155724; font-size: 0.9em; margin-bottom: 10px;">Ujian ini akan cuba membaca data dari Google Sheets.</p>
                        <button class="btn btn-small" id="testLeaderboardBtn">📥 Baca Data</button>
                        <div id="testLeaderboardResult" style="margin-top: 10px; font-weight: 600;"></div>
                    </div>

                    <div style="background: #e7f3ff; border: 2px solid #667eea; padding: 15px; border-radius: 10px;">
                        <h4 style="color: #004085; margin-bottom: 10px;">Test Lengkap (All-in-One)</h4>
                        <p style="color: #004085; font-size: 0.9em; margin-bottom: 10px;">Jalankan semua ujian sekaligus.</p>
                        <button class="btn btn-small" id="testAllBtn">🚀 Jalankan Semua Ujian</button>
                        <div id="testAllProgress" style="margin-top: 10px;"></div>
                    </div>
                </div>

                <div style="margin-top: 20px;">
                    <h3 style="color: #667eea; margin-bottom: 15px;">📋 Log Aktiviti</h3>
                    <div id="adminLog" style="background: #f8f9fa; padding: 15px; border-radius: 10px; max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 0.85em;">
                        <div style="color: #666;">Sistem sedia untuk ujian...</div>
                    </div>
                </div>

                <div style="margin-top: 30px; display: flex; gap: 10px;">
                    <button class="btn btn-secondary" id="viewSheetsBtn">📊 Buka Google Sheets</button>
                    <button class="btn btn-secondary" id="adminLogoutBtn">🚪 Log Keluar</button>
                </div>
            `;

            // Auto check connection on load
            autoCheckConnection();

            document.getElementById('testConnectionBtn').addEventListener('click', testConnection);
            document.getElementById('testSubmitBtn').addEventListener('click', testSubmit);
            document.getElementById('testLeaderboardBtn').addEventListener('click', testLeaderboard);
            document.getElementById('testAllBtn').addEventListener('click', testAll);
            document.getElementById('viewSheetsBtn').addEventListener('click', () => {
                const sheetsUrl = CONFIG.SCRIPT_URL.replace('/exec', '/edit');
                window.open(sheetsUrl, '_blank');
            });
            document.getElementById('adminLogoutBtn').addEventListener('click', () => {
                state.isAdmin = false;
                renderIntro();
            });
        }

        // ===== AUTO CHECK CONNECTION =====
        function autoCheckConnection() {
            addLog('Memeriksa sambungan...');
            testConnection(true);
        }

        // ===== ADD LOG =====
        function addLog(message, type = 'info') {
            const logDiv = document.getElementById('adminLog');
            if (!logDiv) return;

            const time = new Date().toLocaleTimeString('ms-MY');
            let color = '#666';
            let icon = 'ℹ️';

            if (type === 'success') {
                color = '#28a745';
                icon = '✅';
            } else if (type === 'error') {
                color = '#dc3545';
                icon = '❌';
            } else if (type === 'warning') {
                color = '#ffc107';
                icon = '⚠️';
            }

            const logEntry = document.createElement('div');
            logEntry.style.color = color;
            logEntry.style.marginBottom = '5px';
            logEntry.innerHTML = `[${time}] ${icon} ${message}`;
            
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // ===== TEST CONNECTION =====
        function testConnection(silent = false) {
            if (!silent) addLog('Memulakan ujian sambungan...', 'info');
            
            const resultDiv = document.getElementById('testConnectionResult');
            const statusDiv = document.getElementById('connectionStatus');
            
            if (resultDiv) resultDiv.innerHTML = '<span style="color: #17a2b8;">⏳ Menguji...</span>';
            if (statusDiv) statusDiv.innerHTML = '<span style="color: #17a2b8;">Testing...</span>';
            
            const callbackName = 'testCallback_' + Date.now();
            const url = `${CONFIG.SCRIPT_URL}?action=test&callback=${callbackName}`;
            
            const timeout = setTimeout(() => {
                if (window[callbackName]) {
                    if (resultDiv) resultDiv.innerHTML = '<span style="color: #dc3545;">❌ Timeout</span>';
                    if (statusDiv) statusDiv.innerHTML = '<span style="color: #dc3545;">❌ Offline</span>';
                    addLog('Ujian sambungan: TIMEOUT', 'error');
                    cleanup();
                }
            }, 10000);
            
            window[callbackName] = function(response) {
                clearTimeout(timeout);
                console.log('Test response:', response);
                
                if (response && response.success) {
                    if (resultDiv) resultDiv.innerHTML = '<span style="color: #28a745;">✅ Sambungan Berjaya!</span>';
                    if (statusDiv) statusDiv.innerHTML = '<span style="color: #28a745;">✅ Online</span>';
                    addLog('Ujian sambungan: BERJAYA', 'success');
                    if (!silent) showToast('✓ Sambungan berjaya!', 'success');
                } else {
                    if (resultDiv) resultDiv.innerHTML = '<span style="color: #dc3545;">❌ Gagal</span>';
                    if (statusDiv) statusDiv.innerHTML = '<span style="color: #dc3545;">❌ Error</span>';
                    addLog('Ujian sambungan: GAGAL - ' + (response?.error || 'Unknown'), 'error');
                    if (!silent) showToast('✗ Sambungan gagal', 'error');
                }
                
                cleanup();
            };
            
            const script = document.createElement('script');
            script.id = callbackName;
            script.src = url;
            script.onerror = function() {
                clearTimeout(timeout);
                if (resultDiv) resultDiv.innerHTML = '<span style="color: #dc3545;">❌ Network Error</span>';
                if (statusDiv) statusDiv.innerHTML = '<span style="color: #dc3545;">❌ Offline</span>';
                addLog('Ujian sambungan: NETWORK ERROR', 'error');
                if (!silent) showToast('✗ Tidak dapat bersambung', 'error');
                cleanup();
            };
            
            function cleanup() {
                const scriptEl = document.getElementById(callbackName);
                if (scriptEl) scriptEl.remove();
                delete window[callbackName];
            }
            
            document.head.appendChild(script);
        }

        // ===== TEST SUBMIT =====
        function testSubmit() {
            addLog('Memulakan ujian hantar data...', 'info');
            
            const resultDiv = document.getElementById('testSubmitResult');
            resultDiv.innerHTML = '<span style="color: #17a2b8;">⏳ Menghantar data test...</span>';
            
            const testData = {
                action: 'submit',
                nama: 'ADMIN TEST - ' + new Date().toLocaleTimeString(),
                kelas: 'Admin Testing',
                sekolah: 'System Test',
                skor: Math.floor(Math.random() * 10) + 1,
                peratus: Math.floor(Math.random() * 100) + 1,
                durasi: Math.floor(Math.random() * 300000) + 60000,
                tarikh: getISODateInTimezone(),
                quiz_id: CONFIG.QUIZ_ID
            };

            const callbackName = 'submitTest_' + Date.now();
            const params = new URLSearchParams(testData);
            const url = `${CONFIG.SCRIPT_URL}?${params.toString()}&callback=${callbackName}`;
            
            const timeout = setTimeout(() => {
                if (window[callbackName]) {
                    resultDiv.innerHTML = '<span style="color: #ffc107;">⚠️ Timeout (Data mungkin diterima)</span>';
                    addLog('Ujian hantar data: TIMEOUT', 'warning');
                    cleanup();
                }
            }, 10000);
            
            window[callbackName] = function(response) {
                clearTimeout(timeout);
                console.log('Submit test response:', response);
                
                if (response && response.success) {
                    resultDiv.innerHTML = '<span style="color: #28a745;">✅ Data berjaya dihantar ke Google Sheets!</span>';
                    addLog('Ujian hantar data: BERJAYA', 'success');
                    showToast('✓ Data test berjaya dihantar!', 'success');
                } else {
                    resultDiv.innerHTML = '<span style="color: #dc3545;">❌ Gagal: ' + (response?.error || 'Unknown error') + '</span>';
                    addLog('Ujian hantar data: GAGAL - ' + (response?.error || 'Unknown'), 'error');
                    showToast('✗ Gagal menghantar data', 'error');
                }
                
                cleanup();
            };
            
            const script = document.createElement('script');
            script.id = callbackName;
            script.src = url;
            script.onerror = function() {
                clearTimeout(timeout);
                resultDiv.innerHTML = '<span style="color: #ffc107;">⚠️ Request sent (Check sheets manually)</span>';
                addLog('Ujian hantar data: REQUEST SENT (perlu semak sheets)', 'warning');
                showToast('Request sent - check Google Sheets', 'info');
                cleanup();
            };
            
            function cleanup() {
                const scriptEl = document.getElementById(callbackName);
                if (scriptEl) scriptEl.remove();
                delete window[callbackName];
            }
            
            document.head.appendChild(script);
        }

        // ===== TEST LEADERBOARD =====
        function testLeaderboard() {
            addLog('Memulakan ujian baca data...', 'info');
            
            const resultDiv = document.getElementById('testLeaderboardResult');
            resultDiv.innerHTML = '<span style="color: #17a2b8;">⏳ Membaca data...</span>';

            const callbackName = 'leaderboardTest_' + Date.now();
            const url = `${CONFIG.SCRIPT_URL}?action=leaderboard&scope=overall&quiz_id=${CONFIG.QUIZ_ID}&callback=${callbackName}`;
            
            const timeout = setTimeout(() => {
                if (window[callbackName]) {
                    resultDiv.innerHTML = '<span style="color: #dc3545;">❌ Timeout</span>';
                    addLog('Ujian baca data: TIMEOUT', 'error');
                    cleanup();
                }
            }, 10000);
            
            window[callbackName] = function(data) {
                clearTimeout(timeout);
                console.log('Leaderboard test response:', data);
                
                try {
                    let items = [];
                    
                    if (data && data.success && Array.isArray(data.data)) {
                        items = data.data;
                    } else if (Array.isArray(data)) {
                        items = data;
                    }
                    
                    if (items.length > 0) {
                        resultDiv.innerHTML = `<span style="color: #28a745;">✅ Berjaya! Terdapat ${items.length} rekod</span>`;
                        addLog(`Ujian baca data: BERJAYA (${items.length} rekod)`, 'success');
                        showToast(`✓ Berjaya baca ${items.length} rekod!`, 'success');
                    } else {
                        resultDiv.innerHTML = '<span style="color: #ffc107;">⚠️ Tiada data (Sheets mungkin kosong)</span>';
                        addLog('Ujian baca data: SHEETS KOSONG', 'warning');
                        showToast('Sheets kosong atau belum ada data', 'info');
                    }
                } catch (error) {
                    resultDiv.innerHTML = '<span style="color: #dc3545;">❌ Error: ' + error.message + '</span>';
                    addLog('Ujian baca data: ERROR - ' + error.message, 'error');
                    showToast('✗ Error membaca data', 'error');
                }
                
                cleanup();
            };
            
            const script = document.createElement('script');
            script.id = callbackName;
            script.src = url;
            script.onerror = function() {
                clearTimeout(timeout);
                resultDiv.innerHTML = '<span style="color: #dc3545;">❌ Network Error</span>';
                addLog('Ujian baca data: NETWORK ERROR', 'error');
                showToast('✗ Network error', 'error');
                cleanup();
            };
            
            function cleanup() {
                const scriptEl = document.getElementById(callbackName);
                if (scriptEl) scriptEl.remove();
                delete window[callbackName];
            }
            
            document.head.appendChild(script);
        }

        // ===== TEST ALL =====
        async function testAll() {
            const progressDiv = document.getElementById('testAllProgress');
            progressDiv.innerHTML = '<div style="margin-top: 10px; padding: 15px; background: white; border-radius: 10px;"><strong>Menjalankan ujian...</strong></div>';
            
            addLog('=== MEMULAKAN UJIAN LENGKAP ===', 'info');
            
            // Test 1
            progressDiv.innerHTML += '<div style="color: #17a2b8; margin-top: 5px;">⏳ Test 1: Sambungan...</div>';
            await new Promise(resolve => {
                const original = window.testCallback = window['testCallback_' + Date.now()];
                testConnection(true);
                setTimeout(resolve, 3000);
            });
            
            // Test 2
            progressDiv.innerHTML += '<div style="color: #17a2b8; margin-top: 5px;">⏳ Test 2: Hantar data...</div>';
            await new Promise(resolve => {
                testSubmit();
                setTimeout(resolve, 3000);
            });
            
            // Test 3
            progressDiv.innerHTML += '<div style="color: #17a2b8; margin-top: 5px;">⏳ Test 3: Baca data...</div>';
            await new Promise(resolve => {
                testLeaderboard();
                setTimeout(resolve, 3000);
            });
            
            progressDiv.innerHTML += '<div style="color: #28a745; margin-top: 10px; font-weight: 700;">✅ Semua ujian selesai! Semak Log Aktiviti untuk details.</div>';
            addLog('=== UJIAN LENGKAP SELESAI ===', 'success');
            showToast('✓ Semua ujian selesai!', 'success');
        }

        // ===== TEST CONNECTION (ORIGINAL - KEEP FOR BACKWARD COMPATIBILITY) =====
        function testConnection() {
            showToast('Menguji sambungan...', 'info');
            
            const callbackName = 'testCallback_' + Date.now();
            const url = `${CONFIG.SCRIPT_URL}?action=test&callback=${callbackName}`;
            
            window[callbackName] = function(response) {
                console.log('Test response:', response);
                
                if (response && response.success) {
                    showToast('✓ Sambungan berjaya!', 'success');
                } else {
                    showToast('✗ Sambungan gagal', 'error');
                }
                
                const script = document.getElementById(callbackName);
                if (script) script.remove();
                delete window[callbackName];
            };
            
            const script = document.createElement('script');
            script.id = callbackName;
            script.src = url;
            script.onerror = function() {
                showToast('✗ Tidak dapat bersambung ke server', 'error');
                if (script) script.remove();
                delete window[callbackName];
            };
            
            document.head.appendChild(script);
        }

        // ===== MULA KUIZ =====
        function startQuiz() {
            state.questions = CONFIG.RANDOMIZE_QUESTIONS ? shuffleArray(QUESTIONS) : [...QUESTIONS];
            
            state.questions = state.questions.map(q => {
                if (q.type === 'mcq' && CONFIG.RANDOMIZE_CHOICES) {
                    const choices = q.choices.map((choice, idx) => ({ choice, idx }));
                    const shuffled = shuffleArray(choices);
                    return {
                        ...q,
                        choices: shuffled.map(c => c.choice),
                        correct: shuffled.findIndex(c => c.idx === q.correct)
                    };
                }
                if (q.type === 'match') {
                    return {
                        ...q,
                        pairs: shuffleArray(q.pairs),
                        rightOptions: shuffleArray(q.pairs.map(p => p.right))
                    };
                }
                return q;
            });

            state.currentQuestion = 0;
            state.answers = new Array(state.questions.length).fill(null);
            state.startTime = Date.now();
            state.screen = 'quiz';
            
            renderQuiz();
        }

        // ===== RENDER KUIZ =====
        function renderQuiz() {
            const app = document.getElementById('app');
            const question = state.questions[state.currentQuestion];
            const progress = ((state.currentQuestion + 1) / state.questions.length) * 100;

            let questionHTML = '';
            
            if (question.type === 'mcq') {
                questionHTML = `
                    <div class="choices">
                        ${question.choices.map((choice, idx) => `
                            <div class="choice ${state.answers[state.currentQuestion] === idx ? 'selected' : ''}" 
                                 data-idx="${idx}">
                                ${choice}
                            </div>
                        `).join('')}
                    </div>
                `;
            } else if (question.type === 'truefalse') {
                questionHTML = `
                    <div class="choices">
                        <div class="choice ${state.answers[state.currentQuestion] === true ? 'selected' : ''}" 
                             data-answer="true">
                            ✓ Benar
                        </div>
                        <div class="choice ${state.answers[state.currentQuestion] === false ? 'selected' : ''}" 
                             data-answer="false">
                            ✗ Palsu
                        </div>
                    </div>
                `;
            } else if (question.type === 'match') {
                const currentAnswers = state.answers[state.currentQuestion] || {};
                questionHTML = `
                    <div class="match-container">
                        <div class="match-column">
                            <h4>Padankan:</h4>
                            ${question.pairs.map((pair, idx) => `
                                <div class="match-item">
                                    <strong>${String.fromCharCode(65 + idx)}.</strong> ${pair.left}
                                    <select class="match-select" data-idx="${idx}">
                                        <option value="">-- Pilih --</option>
                                        ${question.rightOptions.map((opt, optIdx) => `
                                            <option value="${optIdx}" ${currentAnswers[idx] === optIdx ? 'selected' : ''}>
                                                ${opt}
                                            </option>
                                        `).join('')}
                                    </select>
                                </div>
                            `).join('')}
                        </div>
                        <div class="match-column">
                            <h4>Pilihan:</h4>
                            ${question.rightOptions.map((opt, idx) => `
                                <div class="match-item">
                                    <strong>${idx + 1}.</strong> ${opt}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            app.innerHTML = `
                <div class="header">
                    <h1>📚 Kuiz Sejarah</h1>
                    <p>${state.studentInfo.nama}</p>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${progress}%"></div>
                </div>
                <div class="question-container">
                    <div class="question-header">
                        <div class="question-number">Soalan ${state.currentQuestion + 1} daripada ${state.questions.length}</div>
                        <div class="question-text">${question.question}</div>
                    </div>
                    ${questionHTML}
                </div>
                <button class="btn" id="nextBtn" ${state.answers[state.currentQuestion] === null ? 'disabled' : ''}>
                    ${state.currentQuestion === state.questions.length - 1 ? 'Selesai' : 'Seterusnya'}
                </button>
            `;

            if (question.type === 'mcq') {
                document.querySelectorAll('.choice').forEach(choice => {
                    choice.addEventListener('click', () => {
                        const idx = parseInt(choice.dataset.idx);
                        state.answers[state.currentQuestion] = idx;
                        renderQuiz();
                    });
                });
            } else if (question.type === 'truefalse') {
                document.querySelectorAll('.choice').forEach(choice => {
                    choice.addEventListener('click', () => {
                        const answer = choice.dataset.answer === 'true';
                        state.answers[state.currentQuestion] = answer;
                        renderQuiz();
                    });
                });
            } else if (question.type === 'match') {
                document.querySelectorAll('.match-select').forEach(select => {
                    select.addEventListener('change', () => {
                        const idx = parseInt(select.dataset.idx);
                        const value = select.value === '' ? null : parseInt(select.value);
                        
                        if (!state.answers[state.currentQuestion]) {
                            state.answers[state.currentQuestion] = {};
                        }
                        state.answers[state.currentQuestion][idx] = value;
                        
                        const allAnswered = question.pairs.every((_, i) => 
                            state.answers[state.currentQuestion][i] !== null && 
                            state.answers[state.currentQuestion][i] !== undefined
                        );
                        
                        document.getElementById('nextBtn').disabled = !allAnswered;
                    });
                });
            }

            document.getElementById('nextBtn').addEventListener('click', nextQuestion);
        }

        // ===== SOALAN SETERUSNYA =====
        function nextQuestion() {
            if (state.currentQuestion < state.questions.length - 1) {
                state.currentQuestion++;
                renderQuiz();
            } else {
                finishQuiz();
            }
        }

        // ===== SELESAI KUIZ =====
        function finishQuiz() {
            state.endTime = Date.now();
            
            state.score = 0;
            state.questions.forEach((q, idx) => {
                const answer = state.answers[idx];
                if (q.type === 'mcq') {
                    if (answer === q.correct) state.score++;
                } else if (q.type === 'truefalse') {
                    if (answer === q.correct) state.score++;
                } else if (q.type === 'match') {
                    let allCorrect = true;
                    q.pairs.forEach((pair, pairIdx) => {
                        const selectedIdx = answer[pairIdx];
                        if (q.rightOptions[selectedIdx] !== pair.right) {
                            allCorrect = false;
                        }
                    });
                    if (allCorrect) state.score++;
                }
            });

            state.screen = 'result';
            renderResult();
            submitResult();
        }

        // ===== RENDER KEPUTUSAN =====
        function renderResult() {
            const app = document.getElementById('app');
            const percentage = Math.round((state.score / state.questions.length) * 100);
            const duration = state.endTime - state.startTime;

            let message = '';
            if (percentage >= 80) message = '🎉 Cemerlang! Tahniah!';
            else if (percentage >= 60) message = '👍 Bagus! Teruskan usaha!';
            else if (percentage >= 40) message = '💪 Cuba lagi! Anda boleh buat lebih baik!';
            else message = '📚 Jangan putus asa! Belajar lagi!';

            app.innerHTML = `
                <div class="header">
                    <h1>📊 Keputusan Kuiz</h1>
                </div>
                <div class="result-card">
                    <div class="result-message">${message}</div>
                    <div class="score-display">${state.score}/${state.questions.length}</div>
                    <div class="percentage">${percentage}%</div>
                    <p><strong>Masa:</strong> ${formatDuration(duration)}</p>
                    <p style="margin-top: 20px; color: #666; font-size: 0.95em;">
                        Terima kasih! Keputusan anda telah dihantar.
                    </p>
                    <button class="btn" id="reviewBtn">Semak Jawapan</button>
                    <button class="btn btn-secondary" id="leaderboardBtn">Papan Markah</button>
                    <button class="btn btn-secondary" id="retryBtn">Cuba Lagi</button>
                </div>
            `;

            document.getElementById('reviewBtn').addEventListener('click', renderReview);
            document.getElementById('leaderboardBtn').addEventListener('click', () => {
                state.screen = 'leaderboard';
                renderLeaderboardTabs();
            });
            document.getElementById('retryBtn').addEventListener('click', () => {
                state = {
                    screen: 'intro',
                    studentInfo: {},
                    questions: [],
                    currentQuestion: 0,
                    answers: [],
                    startTime: null,
                    endTime: null,
                    score: 0,
                    submitted: false,
                    isAdmin: false
                };
                renderIntro();
            });
        }

        // ===== RENDER SEMAKAN JAWAPAN =====
        function renderReview() {
            const app = document.getElementById('app');
            
            let reviewHTML = state.questions.map((q, idx) => {
                const answer = state.answers[idx];
                let isCorrect = false;
                let userAnswerText = '';
                let correctAnswerText = '';

                if (q.type === 'mcq') {
                    isCorrect = answer === q.correct;
                    userAnswerText = q.choices[answer];
                    correctAnswerText = q.choices[q.correct];
                } else if (q.type === 'truefalse') {
                    isCorrect = answer === q.correct;
                    userAnswerText = answer ? 'Benar' : 'Palsu';
                    correctAnswerText = q.correct ? 'Benar' : 'Palsu';
                } else if (q.type === 'match') {
                    isCorrect = true;
                    q.pairs.forEach((pair, pairIdx) => {
                        const selectedIdx = answer[pairIdx];
                        if (q.rightOptions[selectedIdx] !== pair.right) {
                            isCorrect = false;
                        }
                    });
                    userAnswerText = q.pairs.map((pair, pairIdx) => {
                        const selectedIdx = answer[pairIdx];
                        return `${pair.left} → ${q.rightOptions[selectedIdx]}`;
                    }).join('<br>');
                    correctAnswerText = q.pairs.map(pair => 
                        `${pair.left} → ${pair.right}`
                    ).join('<br>');
                }

                return `
                    <div class="review-question">
                        <div class="question-number">Soalan ${idx + 1}</div>
                        <div class="question-text">${q.question}</div>
                        <div class="review-answer ${isCorrect ? 'correct-answer' : 'wrong-answer'}">
                            <div class="answer-label">
                                ${isCorrect ? '✓ Jawapan Anda (Betul)' : '✗ Jawapan Anda (Salah)'}
                            </div>
                            <div>${userAnswerText}</div>
                        </div>
                        ${!isCorrect ? `
                            <div class="review-answer correct-answer" style="margin-top: 10px;">
                                <div class="answer-label">✓ Jawapan Betul</div>
                                <div>${correctAnswerText}</div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');

            app.innerHTML = `
                <div class="header">
                    <h1>📝 Semakan Jawapan</h1>
                </div>
                <div class="review-section">
                    ${reviewHTML}
                </div>
                <button class="btn" id="backBtn">Kembali ke Keputusan</button>
                <button class="btn btn-secondary" id="leaderboardBtn2">Papan Markah</button>
            `;

            document.getElementById('backBtn').addEventListener('click', renderResult);
            document.getElementById('leaderboardBtn2').addEventListener('click', () => {
                state.screen = 'leaderboard';
                renderLeaderboardTabs();
            });
        }

        // ===== HANTAR KEPUTUSAN (JSONP METHOD) =====
        function submitResult() {
            if (state.submitted) return;
            
            const duration = state.endTime - state.startTime;
            const percentage = Math.round((state.score / state.questions.length) * 100);
            
            const data = {
                action: 'submit',
                nama: state.studentInfo.nama,
                kelas: state.studentInfo.kelas || '',
                sekolah: state.studentInfo.sekolah || '',
                skor: state.score,
                peratus: percentage,
                durasi: duration,
                tarikh: getISODateInTimezone(),
                quiz_id: CONFIG.QUIZ_ID
            };

            state.submitted = true;
            console.log('Submitting data:', data);

            const callbackName = 'submitCallback_' + Date.now();
            const params = new URLSearchParams(data);
            const url = `${CONFIG.SCRIPT_URL}?${params.toString()}&callback=${callbackName}`;
            
            window[callbackName] = function(response) {
                console.log('Submit response:', response);
                
                if (response && response.success) {
                    showToast('✓ Keputusan berjaya dihantar!', 'success');
                } else {
                    showToast('Keputusan telah direkod', 'info');
                }
                
                const script = document.getElementById(callbackName);
                if (script) script.remove();
                delete window[callbackName];
            };
            
            const script = document.createElement('script');
            script.id = callbackName;
            script.src = url;
            
            script.onerror = function() {
                console.log('Submit failed, but data may have been received');
                showToast('Data telah dihantar', 'info');
                if (script) script.remove();
                delete window[callbackName];
            };
            
            setTimeout(() => {
                const scriptElement = document.getElementById(callbackName);
                if (scriptElement) scriptElement.remove();
                if (window[callbackName]) delete window[callbackName];
            }, 10000);
            
            document.head.appendChild(script);
        }

        // ===== RENDER TAB LEADERBOARD =====
        function renderLeaderboardTabs() {
            const app = document.getElementById('app');
            
            app.innerHTML = `
                <div class="header">
                    <h1>🏆 Papan Markah</h1>
                </div>
                <div class="tabs">
                    <button class="tab active" data-scope="overall">Keseluruhan</button>
                    <button class="tab" data-scope="today">Hari Ini</button>
                </div>
                <div id="leaderboardContent" class="loading">Memuatkan...</div>
                <button class="btn btn-secondary" id="backToResultBtn">Kembali</button>
            `;

            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    fetchLeaderboard(tab.dataset.scope);
                });
            });

            document.getElementById('backToResultBtn').addEventListener('click', renderResult);
            fetchLeaderboard('overall');
        }

        // ===== AMBIL DATA LEADERBOARD =====
        function fetchLeaderboard(scope) {
            const content = document.getElementById('leaderboardContent');
            content.innerHTML = '<div class="loading">Memuatkan data...</div>';

            const callbackName = 'leaderboard_' + Date.now();
            const url = `${CONFIG.SCRIPT_URL}?action=leaderboard&scope=${scope}&quiz_id=${CONFIG.QUIZ_ID}&callback=${callbackName}`;
            
            window[callbackName] = function(data) {
                console.log('Leaderboard response:', data);
                
                try {
                    let items = [];
                    
                    if (data && data.success && Array.isArray(data.data)) {
                        items = data.data;
                    } else if (Array.isArray(data)) {
                        items = data;
                    }
                    
                    if (items.length > 0) {
                        renderLeaderboard(items);
                    } else {
                        content.innerHTML = '<div class="loading">Tiada data tersedia. Cuba lagi dalam beberapa saat.</div>';
                    }
                } catch (error) {
                    console.log('Error processing leaderboard:', error);
                    content.innerHTML = '<div class="loading">Ralat memuatkan data. Sila cuba lagi.</div>';
                }
                
                const script = document.getElementById(callbackName);
                if (script) script.remove();
                delete window[callbackName];
            };
            
            const script = document.createElement('script');
            script.id = callbackName;
            script.src = url;
            
            script.onerror = function() {
                console.log('Leaderboard load failed');
                content.innerHTML = `
                    <div style="text-align: center; padding: 20px;">
                        <p style="margin-bottom: 15px;">Tidak dapat memuatkan papan markah.</p>
                        <button class="btn btn-small" onclick="fetchLeaderboard('${scope}')">Cuba Lagi</button>
                    </div>
                `;
                if (script) script.remove();
                delete window[callbackName];
            };
            
            setTimeout(() => {
                const scriptElement = document.getElementById(callbackName);
                if (scriptElement) {
                    content.innerHTML = `
                        <div style="text-align: center; padding: 20px;">
                            <p style="margin-bottom: 15px;">Masa tamat. Cuba lagi.</p>
                            <button class="btn btn-small" onclick="fetchLeaderboard('${scope}')">Cuba Lagi</button>
                        </div>
                    `;
                    scriptElement.remove();
                }
                if (window[callbackName]) delete window[callbackName];
            }, 15000);
            
            document.head.appendChild(script);
        }

        // ===== RENDER LEADERBOARD =====
        function renderLeaderboard(items) {
            const content = document.getElementById('leaderboardContent');
            const isMobile = window.innerWidth < 480;
            const displayLimit = isMobile ? 10 : CONFIG.LEADERBOARD_LIMIT;
            const displayItems = items.slice(0, displayLimit);

            if (displayItems.length === 0) {
                content.innerHTML = '<div class="loading">Tiada data tersedia</div>';
                return;
            }

            const tableHTML = `
                <table class="leaderboard-table">
                    <thead>
                        <tr>
                            <th>Kedudukan</th>
                            <th>Nama</th>
                            <th>Skor</th>
                            <th>Masa</th>
                            ${!isMobile ? '<th>Sekolah</th>' : ''}
                        </tr>
                    </thead>
                    <tbody>
                        ${displayItems.map((item, idx) => {
                            const rank = idx + 1;
                            let rankClass = 'rank-other';
                            if (rank === 1) rankClass = 'rank-1';
                            else if (rank === 2) rankClass = 'rank-2';
                            else if (rank === 3) rankClass = 'rank-3';

                            return `
                                <tr>
                                    <td><span class="rank-badge ${rankClass}">${rank}</span></td>
                                    <td><strong>${item.nama}</strong>${item.kelas ? `<br><small>${item.kelas}</small>` : ''}</td>
                                    <td><strong>${item.peratus}%</strong><br><small>${item.skor} soalan</small></td>
                                    <td>${formatDuration(item.durasi)}</td>
                                    ${!isMobile ? `<td>${item.sekolah || '-'}</td>` : ''}
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
                ${isMobile && items.length > 10 ? '<p style="text-align: center; margin-top: 15px; color: #666;">Lihat pada skrin lebih besar untuk paparan penuh</p>' : ''}
            `;

            content.innerHTML = tableHTML;
        }

        // ===== INISIALISASI =====
        function init() {
            installAntiCheat();
            renderIntro();
        }

        init();
    </script>
</body>
</html>
