<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kuiz Sejarah Tahun 6 - MEGA EDITION</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%); min-height: 100vh; padding: 20px; color: #333; transition: background 0.3s, color 0.3s; }
        body.dark-mode { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%); color: #e0e0e0; }
        .container { max-width: 900px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); padding: 30px; position: relative; }
        body.dark-mode .container { background: #1e1e1e; color: #e0e0e0; }
        .header { text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 3px solid #667eea; position: relative; }
        .header-controls { position: absolute; top: 0; right: 0; display: flex; gap: 10px; }
        .icon-btn { background: none; border: none; font-size: 1.5em; cursor: pointer; padding: 8px; border-radius: 10px; transition: all 0.3s; }
        .icon-btn:hover { background: rgba(102, 126, 234, 0.1); transform: scale(1.1); }
        .header h1 { color: #667eea; font-size: 2em; margin-bottom: 10px; }
        .timer-display { background: linear-gradient(135deg, #ff6b6b, #ee5a6f); color: white; padding: 15px 25px; border-radius: 15px; font-size: 1.8em; font-weight: 700; text-align: center; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3); animation: pulse 1s infinite; }
        .timer-display.warning { animation: shake 0.5s infinite; background: linear-gradient(135deg, #ff4444, #cc0000); }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.02); } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        .btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 15px 30px; border-radius: 15px; font-size: 1.1em; cursor: pointer; transition: all 0.3s; font-weight: 600; width: 100%; margin-top: 10px; }
        .btn:hover:not(:disabled) { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-secondary { background: #6c757d; }
        .btn-small { padding: 10px 20px; font-size: 0.9em; width: auto; display: inline-block; }
        .choice { background: #f8f9fa; border: 2px solid #ddd; padding: 15px 20px; border-radius: 10px; cursor: pointer; transition: all 0.3s; margin-bottom: 12px; }
        .choice:hover { background: #e9ecef; border-color: #667eea; transform: translateY(-2px); }
        .choice.selected { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-color: #667eea; }
        body.dark-mode .choice { background: #2a2a2a; border-color: #444; color: #e0e0e0; }
        body.dark-mode .choice:hover { background: #333; }
        .achievement-badge { display: inline-block; background: linear-gradient(135deg, #ffd700, #ffed4e); color: #333; padding: 10px 20px; border-radius: 25px; margin: 5px; font-weight: 600; animation: bounceIn 0.5s; box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3); }
        @keyframes bounceIn { 0% { transform: scale(0); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }
        .toast { position: fixed; top: 20px; right: 20px; background: #333; color: white; padding: 15px 20px; border-radius: 10px; z-index: 2000; animation: slideIn 0.3s; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .toast.success { background: #28a745; }
        .toast.error { background: #dc3545; }
        @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #555; }
        body.dark-mode label { color: #b0b0b0; }
        input, select { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 10px; font-size: 16px; }
        body.dark-mode input, body.dark-mode select { background: #2a2a2a; color: #e0e0e0; border-color: #444; }
        .progress-bar { background: #e9ecef; height: 10px; border-radius: 10px; margin-bottom: 20px; overflow: hidden; }
        .progress-fill { background: linear-gradient(90deg, #667eea, #764ba2, #f093fb); height: 100%; transition: width 0.3s; }
        .leaderboard-table { width: 100%; border-collapse: collapse; margin-top: 20px; border-radius: 15px; overflow: hidden; }
        .leaderboard-table th { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px; text-align: left; }
        .leaderboard-table td { padding: 12px; border-bottom: 1px solid #ddd; }
        body.dark-mode .leaderboard-table td { border-bottom-color: #333; }
        .leaderboard-table tr:hover { background: #f8f9fa; }
        body.dark-mode .leaderboard-table tr:hover { background: #2a2a2a; }
        .rank-badge { display: inline-block; width: 35px; height: 35px; line-height: 35px; text-align: center; border-radius: 50%; font-weight: 700; }
        .rank-1 { background: #FFD700; color: #333; }
        .rank-2 { background: #C0C0C0; color: #333; }
        .rank-3 { background: #CD7F32; color: white; }
        .rank-other { background: #6c757d; color: white; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #ddd; flex-wrap: wrap; }
        .tab { padding: 12px 20px; background: transparent; border: none; cursor: pointer; font-weight: 600; color: #666; border-bottom: 3px solid transparent; transition: all 0.3s; }
        body.dark-mode .tab { color: #b0b0b0; }
        .tab.active { color: #667eea; border-bottom-color: #667eea; background: rgba(102, 126, 234, 0.1); }
        .hidden { display: none; }
        .question-header { background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 20px; }
        body.dark-mode .question-header { background: #2a2a2a; }
        .review-section { margin-top: 30px; }
        .review-question { background: #f8f9fa; padding: 20px; border-radius: 15px; margin-bottom: 20px; border-left: 5px solid #667eea; }
        body.dark-mode .review-question { background: #2a2a2a; }
        .review-answer { margin-top: 15px; padding: 10px; border-radius: 8px; }
        .correct-answer { background: #d4edda; border: 2px solid #28a745; }
        .wrong-answer { background: #f8d7da; border: 2px solid #dc3545; }
        @media (max-width: 768px) {
            .container { padding: 20px; }
            .header h1 { font-size: 1.5em; }
            .timer-display { font-size: 1.4em; padding: 12px 20px; }
            .header-controls { position: relative; justify-content: center; margin-bottom: 15px; }
        }
    </style>
</head>
<body>
    <div class="container" id="app"></div>
    
    <script>
        const CONFIG = {
            QUIZ_ID: "SEJARAH_TAHUN6_2024",
            SCRIPT_URL: "https://script.google.com/macros/s/AKfycbw0KvthhUv9QrqfZfBofpdVhKfzJnPZg8BSJp8tsWSAuFCAT2aE2gCnZ_qSHjLjuIim/exec",
            TIMER_PER_QUESTION: 30,
            ADMIN_PASSWORD: "admin123"
        };
        
        const STATES = ["Johor", "Kedah", "Kelantan", "Melaka", "Negeri Sembilan", "Pahang", "Penang", "Perak", "Perlis", "Sabah", "Sarawak", "Selangor", "Terengganu", "WP Kuala Lumpur", "WP Labuan", "WP Putrajaya"];
        
        const ACHIEVEMENTS = {
            perfect: { name: "Perfect Score! ğŸ¯", desc: "100% betul!", icon: "ğŸ¯" },
            speedster: { name: "Speed Demon âš¡", desc: "Selesai < 5 minit", icon: "âš¡" },
            firstTry: { name: "First Try Hero ğŸŒŸ", desc: "Cuba pertama dapat A", icon: "ğŸŒŸ" },
            earlyBird: { name: "Early Bird ğŸ¦", desc: "Quiz sebelum 10am", icon: "ğŸ¦" },
            nightOwl: { name: "Night Owl ğŸ¦‰", desc: "Quiz selepas 10pm", icon: "ğŸ¦‰" }
        };
        
        let QUESTIONS = [
            { type: "mcq", question: "Siapakah yang memberikan idea penggabungan Persekutuan Tanah Melayu pada tahun 1955?", choices: ["Lord Brassey", "Ibrahim Haji Yaakob", "Malcolm MacDonald", "Tunku Abdul Rahman Putra Al-Haj"], correct: 3 },
            { type: "mcq", question: "Apakah konsep yang diperjuangkan oleh tokoh-tokoh tempatan seperti Ibrahim Haji Yaakob dan Harun Aminurrashid?", choices: ["Melayu Rai", "Melayu Raya", "Melayu Bersatu", "Melayu Merdeka"], correct: 1 },
            { type: "mcq", question: "Pembangunan Malaysia akan mempercepat pembangunan infrastruktur, sosial dan ekonomi. Apakah sebab yang bertepatan dengan pernyataan tersebut?", choices: ["Membangunan sosioekonomi", "Mencapai keseimbangan kaum", "Menjamin keselamatan negara", "Mempercepat kemerdekaan"], correct: 0 },
            { type: "mcq", question: "Mengapakah Indonesia mengisytiharkan konfrontasi terhadap Malaysia?", choices: ["Indonesia mahu kekal di bawah pemerintahan Belanda", "Menganggap Malaysia mahu menguasai hasil bumi Indonesia", "Anggapan pembentukan Malaysia menyebabkan rakyatnya berhijrah", "Anggapan pembentukan Malaysia mengancam kedudukan negaranya"], correct: 3 },
            { type: "mcq", question: "Asal usul nama negeri Kedah dikatakan berasal daripada perkataan Arab yang bermaksud cawan atau gelas berkaki. Apakah perkataan Arab tersebut?", choices: ["Qadah", "Malakat", "Kheddah", "prow-lowy"], correct: 0 },
            { type: "mcq", question: "Negeri Sembilan merupakan negeri yang mempunyai keunikan tersendiri dalam penentuan pemimpin negeri. Apakah gelaran ketua negeri bagi Negeri Sembilan?", choices: ["Sultan atau raja", "Yang di-Pertuan Besar", "Yang di-Pertua Negeri", "Yang di-Pertuan Agong"], correct: 1 },
            { type: "mcq", question: "Bandar apakah yang terdapat warisan sejarah seperti istana, galeri dan monumen?", choices: ["Bandar besar", "Bandar diraja", "Bandar bersejarah", "Bandar pentadbiran"], correct: 1 },
            { type: "mcq", question: "Apakah jawatankuasa yang telah merangka dan memperkenalkan Rukun Negara?", choices: ["Jawatankuasa Rukun Negara", "Jawatankuasa Antara Kerajaan", "Jawatankuasa Perpaduan Negara", "Jawatankuasa Setia Kawan Malaysia"], correct: 0 },
            { type: "mcq", question: "Mengapakah pengasingan tempat tinggal menjadi salah satu sebab pengenalan kepada pembentukan Rukun Negara?", choices: ["Keharmonian semua kaum", "Permuafakatan antara kaum", "Kurangnya peluang berinteraksi", "Perpaduan yang kukuh antara kaum"], correct: 2 },
            { type: "mcq", question: "Apakah yang akan terjadi jika Rukun Negara yang diperkenalkan tidak diterima oleh masyarakat?", choices: ["Memupuk kerjasama antara kaum", "Memecahbelahkan hubungan kaum", "Mewujudkan suasana aman dan harmoni", "Menggalakkan perpaduan antara pelbagai kaum"], correct: 1 },
            { type: "mcq", question: "Antara berikut, permainan tradisional yang manakah yang dikategorikan sebagai permainan laman?", items: ["Congkak", "Kabaddi", "Sepak raga", "Paramapadham"], choices: ["I dan II", "I dan IV", "II dan III", "III dan IV"], correct: 2, hasItems: true },
            { type: "mcq", question: "Apakah kaum yang mengenakan sari dan doti sebagai pakaian tradisional kaum mereka?", choices: ["Iban", "Cina", "India", "Baba dan Nyonya"], correct: 2 },
            { type: "mcq", question: "Di manakah kawasan tempat tinggal masyarakat Cina ketika awal kedatangan mereka ke Tanah Melayu?", choices: ["Bandar", "Pedalaman", "Kawasan ladang", "Persisiran pantai"], correct: 0 },
            { type: "mcq", question: "Apakah cara penyebaran agama yang berlaku di Malaysia?", choices: ["Paksaan", "Pengembara", "Pengaruh rakan", "Golongan agama"], correct: 3 },
            { type: "mcq", question: "Apakah kitab suci bagi penganut beragama Sikh?", choices: ["Veda", "Tipitaka", "Al-Quran dan Hadis", "Sri Guru Granth Sahib"], correct: 3 },
            { type: "mcq", question: "Apakah yang terkandung dalam Perkara 11(1) dalam Perlembagaan Persekutuan?", choices: ["Peranan Yang di-Pertuan Agong", "Hak menganuti agama masing-masing", "Ketua Agama Islam bagi negeri tiada raja", "Menguruskan hal ehwal agamanya sendiri"], correct: 1 },
            { type: "mcq", question: "Apakah perayaan yang disambut oleh penganut agama Islam?", choices: ["Deepavali", "Tahun Baru Cina", "Tadau Kaamatan", "Hari Raya Aidiladha"], correct: 3 },
            { type: "mcq", question: "Bagaimanakah cara setiap masyarakat memberikan ucapan semasa perayaan suatu masa dahulu?", choices: ["Menggunakan telefon bimbit", "Memuat naik di media sosial", "Menggunakan media elektronik", "Melalui pos atau serahan tangan"], correct: 3 },
            { type: "mcq", question: "Bagaimanakah pemenang Unduk Ngadau dipilih pada masa kini?", choices: ["Upacara ritual antara peserta", "Berdasarkan semangat Huminodun", "Sesi soal jawab tentang kecantikan peserta", "Sesi soal jawab tentang sejarah masyarakat lampau"], correct: 3 },
            { type: "mcq", question: "Siapakah ketua kerajaan yang mengetuai pentadbiran negara?", choices: ["Menteri Besar", "Perdana Menteri", "Yang di-Pertua Negeri", "Yang di-Pertuan Agong"], correct: 1 },
            { type: "mcq", question: "Siapakah yang digelar sebagai Bapa Pemodenan atas sumbangan beliau kepada negara?", choices: ["Dato' Seri Ismail Sabri bin Yaakob", "Tunku Abdul Rahman Putra Al-Hajj", "Tun Dr. Mahathir bin Mohamad", "Tun Abdul Razak bin Hussein"], correct: 2 },
            { type: "mcq", question: "Antara berikut, yang manakah pencapaian Tun Hussein Onn yang dikenang sehingga kini?", items: ["Mengembalikan keamanan selepas peristiwa 13 Mei", "Memperkenalkan Amanah Saham Nasional Berhad", "Memperkenalkan Program Rukun Tetangga", "Pengenalan Dasar Ekonomi Baru (DEB)"], choices: ["I dan II", "I dan IV", "II dan III", "III dan IV"], correct: 2, hasItems: true },
            { type: "mcq", question: "Meningkatkan pengeluaran bahan makanan tempatan. Apakah industri yang dimaksudkan dengan pernyataan tersebut?", choices: ["Industri hiliran", "Industri asas tani", "Industri perhotelan", "Industri pembuatan"], correct: 1 },
            { type: "mcq", question: "Apakah keistimewaan Malaysia sehingga menjadi tarikan pelancong ke negara ini?", items: ["Keindahan alam semula jadi", "Tapak dan bangunan bersejarah", "Pemimpin yang berbilang kaum", "Kesesakan lalu lintas"], choices: ["I dan II", "I dan IV", "II dan III", "III dan IV"], correct: 0, hasItems: true },
            { type: "mcq", question: "Apakah contoh produk pertanian yang merupakan antara barangan buatan Malaysia?", items: ["Sabun", "Minyak masak", "Minyak pelincir", "Gas untuk memasak"], choices: ["I dan II", "I dan IV", "II dan III", "III dan IV"], correct: 0, hasItems: true },
            { type: "mcq", question: "BAM merupakan akronim bagi persatuan sukan ________?", choices: ["Konfederasi Hoki Malaysia", "Persatuan Badminton Malaysia", "Persatuan Bola Sepak Malaysia", "Kesatuan Olahraga Amatur Malaysia"], correct: 1 },
            { type: "mcq", question: "Apakah dasar yang menggalakkan murid terlibat dalam sekurang-kurangnya satu bidang sukan bermula tahun 2011?", choices: ["1M1S", "MSSM", "RIMUP", "MBMMBI"], correct: 0 },
            { type: "mcq", question: "Apakah sukan yang sinonim dengan penganjuran kejohanan Le Tour de Langkawi?", choices: ["Lumba basikal", "Permotoran", "Bola sepak", "Badminton"], correct: 0 },
            { type: "mcq", question: "Apakah pertubuhan antarabangsa yang keahliannya terbuka kepada semua negara?", choices: ["Komanwel", "Pertubuhan Kerjasama Islam (OIC)", "Pertubuhan Bangsa-Bangsa Bersatu (PBB)", "Pergerakan Negara-negara Berkecuali (NAM)"], correct: 2 },
            { type: "mcq", question: "Apakah makna warna kuning pada logo ASEAN?", choices: ["Kesucian", "Kesopanan", "Keberanian", "Kemakmuran"], correct: 3 },
            { type: "mcq", question: "Mengapakah PBB ditubuhkan?", items: ["Melindungi hak asasi manusia", "Menjamin kestabilan politik dunia", "Meningkatkan taraf hidup penduduk dunia", "Menggalakkan hubungan baik antara negara anggota"], choices: ["I dan II", "I dan IV", "II dan III", "III dan IV"], correct: 3, hasItems: true }
        ];
        
        let state = {
            screen: 'intro', studentInfo: {}, questions: [], currentQuestion: 0, answers: [], startTime: null, endTime: null, score: 0,
            timeLeft: 0, timerInterval: null, achievements: [], soundEnabled: true, darkMode: localStorage.getItem('darkMode') === 'true',
            attempts: parseInt(localStorage.getItem('quiz_attempts_' + CONFIG.QUIZ_ID) || '0'), isAdmin: false
        };
        
        const sounds = {
            correct: () => playTone(800, 200),
            wrong: () => playTone(200, 300),
            finish: () => { playTone(600, 150); setTimeout(() => playTone(800, 300), 200); }
        };
        
        function playTone(freq, duration) {
            if (!state.soundEnabled) return;
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.frequency.value = freq;
                gain.gain.value = 0.1;
                osc.start();
                setTimeout(() => osc.stop(), duration);
            } catch(e) { console.log('Audio not supported'); }
        }
        
        function shuffleArray(arr) {
            const newArr = [...arr];
            for (let i = newArr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArr[i], newArr[j]] = [newArr[j], newArr[i]];
            }
            return newArr;
        }
        
        function formatDuration(ms) {
            const sec = Math.floor(ms / 1000);
            const min = Math.floor(sec / 60);
            return `${min}m ${sec % 60}s`;
        }
        
        function showToast(msg, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = msg;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
        
        function toggleDarkMode() {
            state.darkMode = !state.darkMode;
            document.body.classList.toggle('dark-mode', state.darkMode);
            localStorage.setItem('darkMode', state.darkMode);
            showToast(state.darkMode ? 'ğŸŒ™ Dark Mode ON' : 'â˜€ï¸ Light Mode ON', 'info');
        }
        
        function toggleSound() {
            state.soundEnabled = !state.soundEnabled;
            showToast(state.soundEnabled ? 'ğŸ”Š Sound ON' : 'ğŸ”‡ Sound OFF', 'info');
            const btn = document.querySelector('.icon-btn');
            if (btn) btn.textContent = state.soundEnabled ? 'ğŸ”Š' : 'ğŸ”‡';
        }
        
        function checkAchievements() {
            const ach = [];
            const percentage = Math.round((state.score / state.questions.length) * 100);
            const duration = state.endTime - state.startTime;
            const hour = new Date().getHours();
            
            if (percentage === 100) ach.push(ACHIEVEMENTS.perfect);
            if (duration < 300000) ach.push(ACHIEVEMENTS.speedster);
            if (state.attempts === 1 && percentage >= 80) ach.push(ACHIEVEMENTS.firstTry);
            if (hour < 10) ach.push(ACHIEVEMENTS.earlyBird);
            if (hour >= 22) ach.push(ACHIEVEMENTS.nightOwl);
            
            state.achievements = ach;
            return ach;
        }
        
        function renderIntro() {
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="header">
                    <div class="header-controls">
                        <button class="icon-btn" onclick="toggleSound()" title="Toggle Sound">${state.soundEnabled ? 'ğŸ”Š' : 'ğŸ”‡'}</button>
                        <button class="icon-btn" onclick="toggleDarkMode()" title="Toggle Dark Mode">${state.darkMode ? 'â˜€ï¸' : 'ğŸŒ™'}</button>
                    </div>
                    <h1>ğŸ“š Kuiz Sejarah Tahun 6</h1>
                    <p style="color: #666; margin-top: 10px;">MEGA EDITION âš¡â±ï¸ğŸ¯ğŸ†ğŸŒ™</p>
                </div>
                <form id="introForm">
                    <div class="form-group">
                        <label>Nama Penuh: *</label>
                        <input type="text" id="nama" required minlength="2" maxlength="50" placeholder="Masukkan nama penuh anda">
                    </div>
                    <div class="form-group">
                        <label>Negeri:</label>
                        <select id="negeri">
                            <option value="">Pilih negeri anda...</option>
                            ${STATES.map(s => `<option value="${s}">${s}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Sekolah:</label>
                        <input type="text" id="sekolah" maxlength="100" placeholder="Nama sekolah (optional)">
                    </div>
                    <button type="submit" class="btn">ğŸš€ Mula Kuiz (31 Soalan)</button>
                    <button type="button" class="btn btn-secondary" onclick="state.screen='leaderboard'; renderLeaderboardTabs();">ğŸ† Papan Markah</button>
                    <button type="button" class="btn btn-secondary" onclick="showAdminLogin()">ğŸ” Admin Panel</button>
                </form>
                <p style="text-align: center; margin-top: 20px; color: #666; font-size: 0.9em;">
                    <strong>Features:</strong> â±ï¸ Timer â€¢ ğŸ”Š Sounds â€¢ ğŸ… Badges â€¢ ğŸ† Leaderboard â€¢ ğŸŒ™ Dark Mode
                </p>
            `;
            
            if (state.darkMode) document.body.classList.add('dark-mode');
            
            document.getElementById('introForm').onsubmit = (e) => {
                e.preventDefault();
                state.studentInfo = {
                    nama: document.getElementById('nama').value.trim(),
                    negeri: document.getElementById('negeri').value || 'Tidak dinyatakan',
                    sekolah: document.getElementById('sekolah').value.trim() || ''
                };
                startQuiz();
            };
        }
        
        function showAdminLogin() {
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="header"><h1>ğŸ” Admin Panel</h1></div>
                <form id="adminForm">
                    <div class="form-group">
                        <label>Password Admin:</label>
                        <input type="password" id="adminPwd" required>
                        <small style="color: #dc3545; display: none;" id="adminError">Password salah!</small>
                    </div>
                    <button type="submit" class="btn">Log Masuk</button>
                    <button type="button" class="btn btn-secondary" onclick="renderIntro()">Kembali</button>
                </form>
            `;
            document.getElementById('adminForm').onsubmit = (e) => {
                e.preventDefault();
                if (document.getElementById('adminPwd').value === CONFIG.ADMIN_PASSWORD) {
                    state.isAdmin = true;
                    showAdminPanel();
                } else {
                    document.getElementById('adminError').style.display = 'block';
                }
            };
        }
        
        function showAdminPanel() {
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="header"><h1>âš™ï¸ Admin Dashboard</h1></div>
                <div style="background: #f8f9fa; padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                    <h3 style="color: #667eea; margin-bottom: 15px;">ğŸ“Š Quick Stats</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div style="background: white; padding: 15px; border-radius: 10px; border: 2px solid #667eea;">
                            <div style="color: #666; font-size: 0.9em;">Quiz ID</div>
                            <div style="font-weight: 700; color: #667eea;">${CONFIG.QUIZ_ID}</div>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 10px; border: 2px solid #28a745;">
                            <div style="color: #666; font-size: 0.9em;">Total Soalan</div>
                            <div style="font-weight: 700; color: #28a745;">${QUESTIONS.length}</div>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 10px; border: 2px solid #ff6b6b;">
                            <div style="color: #666; font-size: 0.9em;">Timer Per Soalan</div>
                            <div style="font-weight: 700; color: #ff6b6b;">${CONFIG.TIMER_PER_QUESTION}s</div>
                        </div>
                    </div>
                </div>
                <div style="background: #d1ecf1; border: 2px solid #17a2b8; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                    <h4 style="color: #0c5460;">ğŸ”— Quick Links</h4>
                    <button class="btn btn-small" onclick="window.open('${CONFIG.SCRIPT_URL.replace('/exec', '')}', '_blank')">ğŸ“Š Buka Google Sheets</button>
                    <button class="btn btn-small" onclick="testConnection()">ğŸ”Œ Test Connection</button>
                </div>
                <button class="btn btn-secondary" onclick="state.isAdmin=false; renderIntro()">ğŸšª Log Keluar</button>
            `;
        }
        
        function testConnection() {
            showToast('Testing connection...', 'info');
            const callback = 'test_' + Date.now();
            window[callback] = (r) => {
                if (r && r.success) showToast('âœ… Connection OK!', 'success');
                else showToast('âŒ Connection Failed', 'error');
                delete window[callback];
            };
            const script = document.createElement('script');
            script.src = CONFIG.SCRIPT_URL + '?action=test&callback=' + callback;
            document.head.appendChild(script);
            setTimeout(() => script.remove(), 5000);
        }
        
        function startQuiz() {
            state.questions = shuffleArray(QUESTIONS).map(q => {
                if (q.type === 'mcq') {
                    const choices = q.choices.map((c, i) => ({ c, i }));
                    const shuffled = shuffleArray(choices);
                    return { ...q, choices: shuffled.map(x => x.c), correct: shuffled.findIndex(x => x.i === q.correct) };
                }
                return q;
            });
            state.answers = new Array(state.questions.length).fill(null);
            state.currentQuestion = 0;
            state.startTime = Date.now();
            state.timeLeft = CONFIG.TIMER_PER_QUESTION;
            state.screen = 'quiz';
            renderQuiz();
            startTimer();
        }
        
        function startTimer() {
            if (state.timerInterval) clearInterval(state.timerInterval);
            state.timerInterval = setInterval(() => {
                state.timeLeft--;
                const timerEl = document.getElementById('timer');
                if (timerEl) {
                    timerEl.textContent = `â±ï¸ ${state.timeLeft}s`;
                    if (state.timeLeft <= 10) timerEl.classList.add('warning');
                }
                if (state.timeLeft <= 0) {
                    sounds.wrong();
                    nextQuestion();
                }
            }, 1000);
        }
        
        function renderQuiz() {
            const q = state.questions[state.currentQuestion];
            const progress = ((state.currentQuestion + 1) / state.questions.length) * 100;
            
            let itemsHTML = '';
            if (q.hasItems && q.items) {
                itemsHTML = `
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 2px solid #667eea;">
                        <div style="font-weight: 600; margin-bottom: 10px; color: #667eea;">Pilihan:</div>
                        ${q.items.map((item, i) => `
                            <div style="padding: 8px; margin-bottom: 5px; background: white; border-radius: 5px; border-left: 3px solid #667eea;">
                                <strong>${['I','II','III','IV'][i]}.</strong> ${item}
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="header">
                    <div class="header-controls">
                        <button class="icon-btn" onclick="toggleSound()">${state.soundEnabled ? 'ğŸ”Š' : 'ğŸ”‡'}</button>
                        <button class="icon-btn" onclick="toggleDarkMode()">${state.darkMode ? 'â˜€ï¸' : 'ğŸŒ™'}</button>
                    </div>
                    <h1>ğŸ“š Kuiz Sejarah</h1>
                    <p style="color: #666;">${state.studentInfo.nama}</p>
                </div>
                <div class="timer-display" id="timer">â±ï¸ ${state.timeLeft}s</div>
                <div class="progress-bar"><div class="progress-fill" style="width: ${progress}%"></div></div>
                <div class="question-header">
                    <div style="color: #667eea; font-weight: 700; font-size: 1.1em;">Soalan ${state.currentQuestion + 1} / ${state.questions.length}</div>
                    <div style="font-size: 1.2em; margin-top: 10px; line-height: 1.6;">${q.question}</div>
                </div>
                ${itemsHTML}
                <div class="choices">
                    ${q.choices.map((c, i) => `<div class="choice ${state.answers[state.currentQuestion] === i ? 'selected' : ''}" onclick="selectAnswer(${i})">${c}</div>`).join('')}
                </div>
                <button class="btn" onclick="nextQuestion()" ${state.answers[state.currentQuestion] === null ? 'disabled' : ''}>
                    ${state.currentQuestion === state.questions.length - 1 ? 'âœ… Selesai Kuiz' : 'Seterusnya â¡ï¸'}
                </button>
            `;
        }
        
        function selectAnswer(idx) {
            state.answers[state.currentQuestion] = idx;
            renderQuiz();
        }
        
        function nextQuestion() {
            clearInterval(state.timerInterval);
            
            if (state.currentQuestion < state.questions.length - 1) {
                state.currentQuestion++;
                state.timeLeft = CONFIG.TIMER_PER_QUESTION;
                renderQuiz();
                startTimer();
            } else {
                finishQuiz();
            }
        }
        
        function finishQuiz() {
            clearInterval(state.timerInterval);
            state.endTime = Date.now();
            state.score = 0;
            
            state.questions.forEach((q, i) => {
                if (state.answers[i] === q.correct) state.score++;
            });
            
            state.attempts++;
            localStorage.setItem('quiz_attempts_' + CONFIG.QUIZ_ID, state.attempts);
            
            const achievements = checkAchievements();
            if (achievements.length > 0) sounds.finish();
            else if (state.score >= state.questions.length * 0.8) sounds.correct();
            
            renderResult();
            submitResult();
        }
        
        function renderResult() {
            const percentage = Math.round((state.score / state.questions.length) * 100);
            const duration = state.endTime - state.startTime;
            
            let msg = '';
            if (percentage === 100) msg = 'ğŸ‰ PERFECT! Cemerlang!';
            else if (percentage >= 80) msg = 'ğŸŒŸ Hebat! Cemerlang!';
            else if (percentage >= 60) msg = 'ğŸ‘ Bagus! Teruskan usaha!';
            else if (percentage >= 40) msg = 'ğŸ’ª Cuba lagi!';
            else msg = 'ğŸ“š Jangan putus asa!';
            
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="header">
                    <div class="header-controls">
                        <button class="icon-btn" onclick="toggleDarkMode()">${state.darkMode ? 'â˜€ï¸' : 'ğŸŒ™'}</button>
                    </div>
                    <h1>ğŸ“Š Keputusan Kuiz</h1>
                </div>
                <div style="text-align: center; padding: 40px 20px;">
                    <div style="font-size: 1.5em; margin-bottom: 20px; font-weight: 600;">${msg}</div>
                    <div style="font-size: 4.5em; background: linear-gradient(135deg, #667eea, #764ba2, #f093fb); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 700; margin: 20px 0;">
                        ${state.score}/${state.questions.length}
                    </div>
                    <div style="font-size: 2.5em; color: #666; margin: 20px 0; font-weight: 700;">${percentage}%</div>
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 15px; margin: 20px 0;">
                        <p style="margin: 10px 0;"><strong>â±ï¸ Masa:</strong> ${formatDuration(duration)}</p>
                        <p style="margin: 10px 0;"><strong>ğŸ‘¤ Nama:</strong> ${state.studentInfo.nama}</p>
                        <p style="margin: 10px 0;"><strong>ğŸ“ Negeri:</strong> ${state.studentInfo.negeri}</p>
                        <p style="margin: 10px 0;"><strong>ğŸ”„ Percubaan:</strong> ${state.attempts}</p>
                    </div>
                    
                    ${state.achievements.length > 0 ? `
                        <div style="margin-top: 30px; padding: 25px; background: linear-gradient(135deg, rgba(255,215,0,0.1), rgba(255,237,78,0.1)); border-radius: 15px; border: 3px solid #ffd700;">
                            <h3 style="color: #667eea; margin-bottom: 15px; font-size: 1.5em;">ğŸ… Pencapaian Baru Dibuka!</h3>
                            ${state.achievements.map(a => `<div class="achievement-badge">${a.icon} ${a.name}<br><small style="font-size: 0.8em;">${a.desc}</small></div>`).join('')}
                        </div>
                    ` : ''}
                    
                    <div style="margin-top: 30px;">
                        <button class="btn" onclick="renderReview()">ğŸ“ Semak Jawapan</button>
                        <button class="btn btn-secondary" onclick="renderIntro()">ğŸ”„ Cuba Lagi</button>
                        <button class="btn btn-secondary" onclick="state.screen='leaderboard'; renderLeaderboardTabs();">ğŸ† Papan Markah Malaysia</button>
                    </div>
                </div>
            `;
        }
        
        function renderReview() {
            const app = document.getElementById('app');
            
            const reviewHTML = state.questions.map((q, idx) => {
                const answer = state.answers[idx];
                const isCorrect = answer === q.correct;
                const userAnswer = q.choices[answer];
                const correctAnswer = q.choices[q.correct];
                
                return `
                    <div class="review-question">
                        <div style="color: #667eea; font-weight: 700; margin-bottom: 5px;">Soalan ${idx + 1}</div>
                        <div style="font-size: 1.1em; margin-bottom: 15px;">${q.question}</div>
                        ${q.hasItems ? `
                            <div style="background: #f0f0f0; padding: 10px; border-radius: 8px; margin-bottom: 10px;">
                                ${q.items.map((item, i) => `<div style="padding: 5px;"><strong>${['I','II','III','IV'][i]}.</strong> ${item}</div>`).join('')}
                            </div>
                        ` : ''}
                        <div class="review-answer ${isCorrect ? 'correct-answer' : 'wrong-answer'}">
                            <div style="font-weight: 600; margin-bottom: 5px;">
                                ${isCorrect ? 'âœ… Jawapan Anda (Betul!)' : 'âŒ Jawapan Anda (Salah)'}
                            </div>
                            <div>${userAnswer}</div>
                        </div>
                        ${!isCorrect ? `
                            <div class="review-answer correct-answer" style="margin-top: 10px;">
                                <div style="font-weight: 600; margin-bottom: 5px;">âœ… Jawapan Yang Betul</div>
                                <div>${correctAnswer}</div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
            
            app.innerHTML = `
                <div class="header"><h1>ğŸ“ Semakan Jawapan</h1></div>
                <div style="background: #fff3cd; border: 2px solid #ffc107; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                    <strong>ğŸ’¡ Tips:</strong> Baca dan fahami jawapan yang betul. Cuba quiz lagi untuk improve!
                </div>
                <div class="review-section">${reviewHTML}</div>
                <button class="btn" onclick="renderResult()">â¬…ï¸ Kembali ke Keputusan</button>
                <button class="btn btn-secondary" onclick="renderIntro()">ğŸ”„ Cuba Lagi</button>
            `;
        }
        
        function submitResult() {
            const data = {
                action: 'submit',
                nama: state.studentInfo.nama,
                negeri: state.studentInfo.negeri,
                sekolah: state.studentInfo.sekolah,
                skor: state.score,
                peratus: Math.round((state.score / state.questions.length) * 100),
                durasi: state.endTime - state.startTime,
                tarikh: new Date().toISOString(),
                quiz_id: CONFIG.QUIZ_ID,
                achievements: state.achievements.map(a => a.name).join(', ')
            };
            
            const callback = 'submit_' + Date.now();
            const params = new URLSearchParams(data);
            const url = `${CONFIG.SCRIPT_URL}?${params}&callback=${callback}`;
            
            window[callback] = (r) => {
                if (r && r.success) showToast('âœ… Keputusan dihantar!', 'success');
                else console.log('Submit response:', r);
                delete window[callback];
            };
            
            const script = document.createElement('script');
            script.src = url;
            document.head.appendChild(script);
            setTimeout(() => script.remove(), 8000);
        }
        
        function renderLeaderboardTabs() {
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="header">
                    <div class="header-controls">
                        <button class="icon-btn" onclick="toggleDarkMode()">${state.darkMode ? 'â˜€ï¸' : 'ğŸŒ™'}</button>
                    </div>
                    <h1>ğŸ† Papan Markah Malaysia</h1>
                </div>
                <div class="tabs">
                    <button class="tab active" onclick="fetchLeaderboard('overall', this)">ğŸ‡²ğŸ‡¾ Keseluruhan</button>
                    <button class="tab" onclick="fetchLeaderboard('today', this)">ğŸ“… Hari Ini</button>
                    <button class="tab" onclick="fetchLeaderboard('week', this)">ğŸ“† Minggu Ini</button>
                    <button class="tab" onclick="fetchLeaderboard('month', this)">ğŸ—“ï¸ Bulan Ini</button>
                </div>
                <div style="margin: 20px 0;">
                    <label style="font-weight: 600; display: block; margin-bottom: 8px;">ğŸ” Filter Negeri:</label>
                    <select id="negeriFilter" style="width: 100%; padding: 10px; border-radius: 10px; border: 2px solid #667eea;">
                        <option value="">Semua Negeri</option>
                        ${STATES.map(s => `<option value="${s}">${s}</option>`).join('')}
                    </select>
                </div>
                <div id="leaderboardContent">Memuatkan...</div>
                <button class="btn btn-secondary" onclick="renderIntro()">ğŸ  Kembali</button>
            `;
            
            document.getElementById('negeriFilter').onchange = () => fetchLeaderboard('overall');
            fetchLeaderboard('overall');
        }
        
        function fetchLeaderboard(scope, tabEl) {
            if (tabEl) {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                tabEl.classList.add('active');
            }
            
            const content = document.getElementById('leaderboardContent');
            content.innerHTML = '<div style="text-align: center; padding: 20px;">â³ Memuatkan data...</div>';
            
            const negeri = document.getElementById('negeriFilter')?.value || '';
            const callback = 'leaderboard_' + Date.now();
            const url = `${CONFIG.SCRIPT_URL}?action=leaderboard&scope=${scope}&quiz_id=${CONFIG.QUIZ_ID}&negeri=${negeri}&callback=${callback}`;
            
            window[callback] = (data) => {
                let items = [];
                if (data && data.success && Array.isArray(data.data)) items = data.data;
                else if (Array.isArray(data)) items = data;
                
                if (items.length > 0) renderLeaderboard(items);
                else content.innerHTML = '<div style="text-align: center; padding: 40px; background: #f8f9fa; border-radius: 15px;"><p style="font-size: 1.2em; color: #666;">ğŸ“Š Tiada data untuk paparan ini</p><p style="color: #999; margin-top: 10px;">Cuba filter atau scope yang lain</p></div>';
                
                delete window[callback];
            };
            
            const script = document.createElement('script');
            script.src = url;
            document.head.appendChild(script);
            setTimeout(() => {
                if (window[callback]) {
                    content.innerHTML = '<div style="text-align: center; padding: 40px; background: #fff3cd; border-radius: 15px;"><p style="color: #856404;">âš ï¸ Timeout loading data</p><button class="btn btn-small" onclick="fetchLeaderboard(\'' + scope + '\')">ğŸ”„ Cuba Lagi</button></div>';
                }
                script.remove();
            }, 15000);
        }
        
        function renderLeaderboard(items) {
            const content = document.getElementById('leaderboardContent');
            const isMobile = window.innerWidth < 768;
            
            content.innerHTML = `
                <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 15px; text-align: center;">
                    <strong style="color: #667eea; font-size: 1.2em;">ğŸ“Š ${items.length} Peserta</strong>
                </div>
                <table class="leaderboard-table">
                    <thead>
                        <tr>
                            <th style="width: 60px;">ğŸ… Rank</th>
                            <th>ğŸ‘¤ Nama</th>
                            ${!isMobile ? '<th>ğŸ“ Negeri</th>' : ''}
                            <th style="width: 100px;">ğŸ“Š Skor</th>
                            <th style="width: 100px;">â±ï¸ Masa</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${items.map((item, i) => {
                            const rank = i + 1;
                            let badgeClass = 'rank-other';
                            if (rank === 1) badgeClass = 'rank-1';
                            else if (rank === 2) badgeClass = 'rank-2';
                            else if (rank === 3) badgeClass = 'rank-3';
                            
                            return `
                                <tr>
                                    <td><span class="rank-badge ${badgeClass}">${rank}</span></td>
                                    <td>
                                        <strong style="font-size: 1.1em;">${item.nama}</strong>
                                        ${item.sekolah ? `<br><small style="color: #666;">${item.sekolah}</small>` : ''}
                                    </td>
                                    ${!isMobile ? `<td>${item.negeri || '-'}</td>` : ''}
                                    <td>
                                        <strong style="color: #667eea; font-size: 1.2em;">${item.peratus}%</strong>
                                        <br><small>${item.skor} soalan</small>
                                    </td>
                                    <td>${formatDuration(item.durasi)}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
                ${isMobile && items.length > 10 ? '<p style="text-align: center; margin-top: 15px; color: #666;"><small>ğŸ’¡ Lihat pada skrin lebih besar untuk paparan penuh</small></p>' : ''}
            `;
        }
        
        renderIntro();
    </script>
</body>
</html>
