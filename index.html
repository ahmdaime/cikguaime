<!DOCTYPE html>
<html lang="ms">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kuiz Interaktif Sejarah Tahun 5</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Base styles */
        html {
            scroll-behavior: smooth;
        }

        body {
            box-sizing: border-box;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* Disable text selection */
        * {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            box-sizing: border-box;
        }

        /* Allow selection only for input fields */
        input,
        textarea {
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }

        /* Focus states - Green theme */
        *:focus-visible {
            outline: 2px solid #10b981;
            outline-offset: 2px;
        }

        /* Better touch targets */
        button, .btn, [role="button"] {
            min-height: 44px;
        }

        /* Active states for mobile */
        button:active, .btn:active {
            transform: scale(0.98);
        }

        /* Drag & Drop */
        .drag-item {
            cursor: grab;
            transition: all 0.3s ease;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .drag-item:active {
            cursor: grabbing;
            transform: scale(1.02);
        }

        .drop-zone {
            min-height: 48px;
            border: 2px dashed #cbd5e1;
            transition: all 0.3s ease;
        }

        .drop-zone.drag-over {
            border-color: #10b981;
            background-color: #ecfdf5;
            transform: scale(1.02);
        }

        .drop-zone.filled {
            border-color: #10b981;
            background-color: #f0fdf4;
            border-style: solid;
        }

        /* Animations */
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(15px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-10px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.02);
            }
        }

        @keyframes bounce {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-5px);
            }
        }

        .animate-fade-in-up {
            animation: fadeInUp 0.4s ease-out;
        }

        .animate-slide-in {
            animation: slideIn 0.3s ease-out;
        }

        .animate-bounce-subtle {
            animation: bounce 0.5s ease-in-out;
        }

        /* Hover animations */
        .hover-lift {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .hover-lift:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        /* Card animations */
        .card-animate {
            transition: all 0.3s ease;
        }

        .card-animate:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        /* Button hover effects */
        .btn-animate {
            transition: all 0.2s ease;
        }

        .btn-animate:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        /* Progress bar animation */
        .progress-animate {
            transition: width 0.5s ease-out;
        }

        /* Security overlay for developer tools detection */
        .security-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 9999;
            display: none;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 24px;
            text-align: center;
        }

        /* Mobile responsive utilities */
        @media (max-width: 640px) {
            .mobile-stack {
                flex-direction: column;
                gap: 0.5rem;
            }

            .mobile-full {
                width: 100%;
            }
        }
    </style>
</head>

<body class="bg-gradient-to-br from-green-50 to-emerald-100 min-h-screen font-sans">
    <!-- Security Overlay -->
    <div id="securityOverlay" class="security-overlay">
        <div class="text-center">
            <div class="text-6xl mb-4">üîí</div>
            <h2 class="text-3xl font-bold mb-4">AKSES DILARANG</h2>
            <p class="text-xl mb-4">Developer tools telah dikesan!</p>
            <p class="text-lg mb-6">Sila tutup developer tools untuk meneruskan kuiz.</p>
            <div class="text-sm opacity-75">
                <p>Sistem Keselamatan CikguAime</p>
                <p>Melindungi integriti kuiz</p>
            </div>
        </div>
    </div>

    <div class="container mx-auto px-3 sm:px-4 py-4 sm:py-6 md:py-8 max-w-4xl">
        <!-- Header -->
        <header class="text-center mb-6 sm:mb-8 animate-fade-in-up">
            <h1 class="text-2xl sm:text-3xl md:text-4xl font-bold text-emerald-800 mb-2">üìö Kuiz Interaktif Sejarah Tahun 5</h1>
            <p class="text-sm sm:text-base text-gray-600">Ujian komprehensif dengan soalan rawak untuk pembelajaran yang berkesan</p>

            <!-- Professional Watermark -->
            <div
                class="mt-6 p-4 bg-gradient-to-r from-emerald-50 to-teal-50 border border-emerald-200 rounded-lg shadow-sm">
                <div class="flex items-center justify-center space-x-3">
                    <div class="text-2xl">üë©‚Äçüè´</div>
                    <div class="text-center">
                        <p class="text-sm font-medium text-teal-800">Sistem Kuiz Dibina Oleh</p>
                        <div class="flex items-center space-x-2">
                            <span class="text-lg font-bold text-teal-900">CikguAime</span>
                            <span class="text-teal-600">‚Ä¢</span>
                            <a href="https://www.cikguaime.com/" target="_blank" rel="noopener noreferrer"
                                class="text-sm text-blue-600 hover:text-blue-800 hover:underline transition-colors duration-300">
                                www.cikguaime.com
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Student Info Form -->
        <div id="studentInfoForm" class="bg-white rounded-2xl shadow-lg p-4 sm:p-6 md:p-8 card-animate">
            <div class="mb-6 sm:mb-8 text-center">
                <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-3 sm:mb-4">Maklumat Murid</h2>
                <p class="text-sm sm:text-base text-gray-600 mb-4 sm:mb-6">Sila isi maklumat anda sebelum memulakan kuiz</p>
            </div>

            <div class="max-w-md mx-auto space-y-4 sm:space-y-6">
                <div>
                    <label for="studentName" class="block text-xs sm:text-sm font-medium text-gray-700 mb-1.5 sm:mb-2">Nama Penuh:</label>
                    <input type="text" id="studentName"
                        class="w-full p-3 sm:p-4 text-base border-2 border-gray-300 rounded-xl focus:border-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-200 transition-all duration-200"
                        placeholder="Masukkan nama penuh anda">
                </div>

                <div>
                    <label for="studentClass" class="block text-xs sm:text-sm font-medium text-gray-700 mb-1.5 sm:mb-2">Kelas:</label>
                    <input type="text" id="studentClass"
                        class="w-full p-3 sm:p-4 text-base border-2 border-gray-300 rounded-xl focus:border-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-200 transition-all duration-200"
                        placeholder="Contoh: 5 Bestari">
                </div>

                <div>
                    <label for="studentSchool" class="block text-xs sm:text-sm font-medium text-gray-700 mb-1.5 sm:mb-2">Sekolah:</label>
                    <input type="text" id="studentSchool"
                        class="w-full p-3 sm:p-4 text-base border-2 border-gray-300 rounded-xl focus:border-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-200 transition-all duration-200"
                        placeholder="Nama sekolah anda">
                </div>

                <button onclick="submitStudentInfo()"
                    class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 sm:py-4 px-6 rounded-xl transition-all duration-300 hover:shadow-lg btn-animate">
                    Teruskan ke Menu Kuiz
                </button>
            </div>
        </div>

        <!-- Main Menu -->
        <div id="mainMenu" class="hidden bg-white rounded-2xl shadow-lg p-4 sm:p-6 md:p-8 text-center card-animate">
            <div class="mb-6 sm:mb-8">
                <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-3 sm:mb-4">Pilih Bahagian Kuiz</h2>
                <p class="text-sm sm:text-base text-gray-600 mb-4 sm:mb-6">Setiap bahagian mempunyai soalan yang berbeza dan akan diacak secara rawak</p>
                <div class="bg-emerald-50 p-3 sm:p-4 rounded-xl mb-4 sm:mb-6 border border-emerald-200">
                    <p class="text-xs sm:text-sm text-emerald-800"><strong>Jumlah Markah:</strong> 50 markah (A: 30, B: 10, C: 10)</p>
                </div>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 sm:gap-4 md:gap-6 mb-4 sm:mb-6">
                <button onclick="startSection('A')"
                    class="bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-bold py-4 sm:py-6 px-4 sm:px-6 rounded-xl transform hover:scale-105 transition-all duration-300 shadow-lg hover-lift">
                    <div class="text-3xl mb-2">üìù¬ù</div>
                    <div class="text-xl mb-2">Bahagian A</div>
                    <div class="text-sm opacity-90">30 Soalan Objektif</div>
                </button>

                <button onclick="startSection('B')"
                    class="bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-bold py-4 sm:py-6 px-4 sm:px-6 rounded-xl transform hover:scale-105 transition-all duration-300 shadow-lg hover-lift">
                    <div class="text-3xl mb-2">üìã</div>
                    <div class="text-xl mb-2">Bahagian B</div>
                    <div class="text-sm opacity-90">2 Soalan Struktur</div>
                </button>

                <button onclick="startSection('C')"
                    class="bg-gradient-to-r from-emerald-500 to-teal-600 hover:from-emerald-600 hover:to-teal-700 text-white font-bold py-4 sm:py-6 px-4 sm:px-6 rounded-xl transform hover:scale-105 transition-all duration-300 shadow-lg hover-lift">
                    <div class="text-3xl mb-2">‚úèÔ∏è</div>
                    <div class="text-xl mb-2">Bahagian C</div>
                    <div class="text-sm opacity-90">4 Soalan Jawapan Pendek</div>
                </button>
            </div>

            <div class="text-center">
                <button onclick="showLeaderboard()"
                    class="bg-gradient-to-r from-yellow-500 to-orange-500 hover:from-yellow-600 hover:to-orange-600 text-white font-bold py-2 sm:py-3 px-4 sm:px-6 rounded-xl transform hover:scale-105 transition-all duration-300 shadow-lg hover-lift text-sm sm:text-base">
                    üèÜ Papan Pendahulu
                </button>
            </div>
        </div>

        <!-- Quiz Container -->
        <div id="quizContainer" class="hidden">
            <!-- Progress Bar -->
            <div class="bg-white rounded-2xl shadow-lg p-4 sm:p-6 mb-6">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-sm font-medium text-gray-700">Kemajuan</span>
                    <span id="progressText" class="text-sm font-medium text-gray-700">1 / 30</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-3">
                    <div id="progressBar"
                        class="bg-gradient-to-r from-emerald-500 to-teal-600 h-3 rounded-full transition-all duration-500"
                        style="width: 0%"></div>
                </div>
            </div>

            <!-- Question Card -->
            <div id="questionCard" class="bg-white rounded-2xl shadow-lg p-4 sm:p-6 md:p-8 mb-6 fade-in">
                <div id="questionContent"></div>
            </div>

            <!-- Navigation -->
            <div class="flex justify-between items-center gap-2 sm:gap-4">
                <button id="prevBtn" onclick="previousQuestion()"
                    class="flex-1 sm:flex-none bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-3 sm:px-6 rounded-xl transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed text-sm sm:text-base">
                    ‚Üê¬ê Sebelum
                </button>

                <button id="nextBtn" onclick="nextQuestion()"
                    class="flex-1 sm:flex-none bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-3 sm:px-6 rounded-xl transition-all duration-300 hover:shadow-lg btn-animate text-sm sm:text-base">
                    Seterusnya ‚Üí
                </button>

                <button id="submitBtn" onclick="submitQuiz()"
                    class="hidden flex-1 sm:flex-none bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-3 sm:px-6 rounded-xl transition-all duration-300 hover:shadow-lg text-sm sm:text-base">
                    Hantar Jawapan
                </button>
            </div>
        </div>

        <!-- Results -->
        <div id="resultsContainer" class="hidden bg-white rounded-2xl shadow-lg p-4 sm:p-6 md:p-8 text-center animate-fade-in-up">
            <div class="mb-4 sm:mb-6">
                <div class="text-4xl sm:text-5xl md:text-6xl mb-3 sm:mb-4 animate-bounce-subtle">üéâ</div>
                <h2 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-2">Tahniah!</h2>
                <p class="text-sm sm:text-base text-gray-600">Anda telah selesai menjawab kuiz</p>
            </div>

            <div id="scoreDisplay" class="text-2xl sm:text-3xl md:text-4xl font-bold text-emerald-600 mb-4 sm:mb-6"></div>

            <div id="navigationButtons" class="flex flex-col sm:flex-row justify-center gap-3 sm:gap-4 mb-4 sm:mb-6">
                <button onclick="restartQuiz()"
                    class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 sm:py-3 px-4 sm:px-6 rounded-xl transition-all duration-300 hover:shadow-lg btn-animate">
                    Cuba Lagi
                </button>
                <button onclick="backToMenu()"
                    class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 sm:py-3 px-4 sm:px-6 rounded-xl transition-colors duration-300">
                    Menu Utama
                </button>
            </div>

            <div id="nextSectionButton" class="hidden mb-6">
                <button onclick="goToNextSection()"
                    class="bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-8 rounded-lg transition-colors duration-300 text-lg">
                    <span id="nextSectionText">Teruskan ke Bahagian B</span> ‚Üí
                </button>
            </div>

            <div class="flex justify-center gap-4">
                <div id="reviewMistakes" class="hidden">
                    <button onclick="showMistakeReview()"
                        class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 sm:py-3 px-4 sm:px-6 rounded-xl transition-colors duration-300">
                        üìã Semak Kesilapan
                    </button>
                </div>
                <div id="showTeacherAnswers" class="hidden">
                    <button onclick="showTeacherAnswers()"
                        class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 sm:py-3 px-4 sm:px-6 rounded-xl transition-colors duration-300">
                        üë©‚Äçüè´ Jawapan Guru
                    </button>
                </div>
            </div>
        </div>

        <!-- Mistake Review -->
        <div id="mistakeReviewContainer" class="hidden bg-white rounded-2xl shadow-lg p-4 sm:p-6 md:p-8">
            <div class="mb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-2">üìã Semakan Kesilapan</h2>
                <p class="text-gray-600">Semak jawapan yang salah untuk pembelajaran yang lebih baik</p>
            </div>

            <div id="mistakesList" class="space-y-6 mb-6"></div>

            <div class="text-center">
                <button onclick="closeMistakeReview()"
                    class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 sm:py-3 px-4 sm:px-6 rounded-xl transition-colors duration-300">
                    Tutup
                </button>
            </div>
        </div>

        <!-- Teacher Answers -->
        <div id="teacherAnswersContainer" class="hidden bg-white rounded-2xl shadow-lg p-4 sm:p-6 md:p-8">
            <div class="mb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-2">üë©‚Äçüè´ Jawapan Guru - Bahagian C</h2>
                <p class="text-gray-600">Rujukan jawapan lengkap untuk pembelajaran tambahan</p>
            </div>

            <div id="teacherAnswersList" class="space-y-6 mb-6"></div>

            <div class="text-center">
                <button onclick="closeTeacherAnswers()"
                    class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 sm:py-3 px-4 sm:px-6 rounded-xl transition-colors duration-300">
                    Tutup
                </button>
            </div>
        </div>

        <!-- Leaderboard -->
        <div id="leaderboardContainer" class="hidden bg-white rounded-2xl shadow-lg p-4 sm:p-6 md:p-8">
            <div class="mb-6 text-center">
                <h2 class="text-2xl font-bold text-gray-800 mb-2">üèÜ Papan Pendahulu</h2>
                <p class="text-gray-600">Kedudukan terbaik murid-murid</p>
            </div>

            <div id="leaderboardList" class="space-y-3 mb-6"></div>

            <div class="text-center">
                <button onclick="closeLeaderboard()"
                    class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 sm:py-3 px-4 sm:px-6 rounded-xl transition-colors duration-300">
                    Tutup
                </button>
                <button onclick="refreshLeaderboard()"
                    class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 sm:py-3 px-4 sm:px-6 rounded-xl transition-colors duration-300 ml-3">
                    üîÑ Muat Semula
                </button>
            </div>
        </div>

        <!-- Footer Watermark -->
        <footer class="mt-12 text-center">
            <div class="inline-block p-3 bg-white border border-gray-200 rounded-lg shadow-sm">
                <div class="flex items-center space-x-2 text-sm text-gray-600">
                    <span>üíª Powered by</span>
                    <a href="https://www.cikguaime.com/" target="_blank" rel="noopener noreferrer"
                        class="font-semibold text-teal-600 hover:text-teal-800 transition-colors duration-300">
                        CikguAime
                    </a>
                    <span>|</span>
                    <span class="text-xs text-gray-500">Sistem Pembelajaran Interaktif</span>
                </div>
            </div>
        </footer>
    </div>

    <script>
        // üîí SISTEM KESELAMATAN KUIZ - CIKGUAIME üîí

        // Disable right-click context menu
        document.addEventListener('contextmenu', function (e) {
            e.preventDefault();
            showSecurityWarning('Klik kanan dilarang semasa kuiz!');
            return false;
        });

        // Disable F12, Ctrl+Shift+I, Ctrl+U, Ctrl+S, Ctrl+A, Ctrl+C, Ctrl+V
        document.addEventListener('keydown', function (e) {
            // F12 - Developer Tools
            if (e.keyCode === 123) {
                e.preventDefault();
                showSecurityWarning('Developer tools dilarang!');
                return false;
            }

            // Ctrl+Shift+I - Developer Tools
            if (e.ctrlKey && e.shiftKey && e.keyCode === 73) {
                e.preventDefault();
                showSecurityWarning('Developer tools dilarang!');
                return false;
            }

            // Ctrl+Shift+C - Element Inspector
            if (e.ctrlKey && e.shiftKey && e.keyCode === 67) {
                e.preventDefault();
                showSecurityWarning('Element inspector dilarang!');
                return false;
            }

            // Ctrl+U - View Source
            if (e.ctrlKey && e.keyCode === 85) {
                e.preventDefault();
                showSecurityWarning('View source dilarang!');
                return false;
            }

            // Ctrl+S - Save Page
            if (e.ctrlKey && e.keyCode === 83) {
                e.preventDefault();
                showSecurityWarning('Menyimpan halaman dilarang!');
                return false;
            }

            // Ctrl+A - Select All (except in input fields)
            if (e.ctrlKey && e.keyCode === 65) {
                if (!['INPUT', 'TEXTAREA'].includes(e.target.tagName)) {
                    e.preventDefault();
                    showSecurityWarning('Select all dilarang!');
                    return false;
                }
            }

            // Ctrl+C - Copy (except in input fields)
            if (e.ctrlKey && e.keyCode === 67) {
                if (!['INPUT', 'TEXTAREA'].includes(e.target.tagName)) {
                    e.preventDefault();
                    showSecurityWarning('Copy dilarang!');
                    return false;
                }
            }

            // Ctrl+V - Paste (except in input fields)
            if (e.ctrlKey && e.keyCode === 86) {
                if (!['INPUT', 'TEXTAREA'].includes(e.target.tagName)) {
                    e.preventDefault();
                    showSecurityWarning('Paste dilarang!');
                    return false;
                }
            }

            // Ctrl+Shift+J - Console
            if (e.ctrlKey && e.shiftKey && e.keyCode === 74) {
                e.preventDefault();
                showSecurityWarning('Console dilarang!');
                return false;
            }
        });

        // Detect developer tools opening (more accurate detection)
        let devtools = {
            open: false,
            orientation: null
        };

        // More conservative threshold to avoid false positives
        const threshold = 200;

        setInterval(function () {
            // Only check if window is focused to avoid false positives
            if (document.hasFocus()) {
                const heightDiff = window.outerHeight - window.innerHeight;
                const widthDiff = window.outerWidth - window.innerWidth;

                // More strict detection - both dimensions must exceed threshold
                if (heightDiff > threshold && widthDiff > threshold) {
                    if (!devtools.open) {
                        devtools.open = true;
                        showSecurityOverlay();
                    }
                } else {
                    if (devtools.open) {
                        devtools.open = false;
                        hideSecurityOverlay();
                    }
                }
            }
        }, 1000); // Less frequent checking

        // Detect console usage
        // Detect console usage
        let consoleWarningShown = false;
        // Save original methods individually to avoid reference issues
        const originalConsoleMethods = {
            log: window.console.log,
            warn: window.console.warn,
            error: window.console.error,
            info: window.console.info,
            debug: window.console.debug
        };

        // Override console methods
        ['log', 'warn', 'error', 'info', 'debug'].forEach(method => {
            window.console[method] = function () {
                if (!consoleWarningShown) {
                    consoleWarningShown = true;
                    showSecurityWarning('Console usage dikesan! Kuiz mungkin tidak sah.');
                }
                // Use the saved original method
                if (originalConsoleMethods[method]) {
                    return originalConsoleMethods[method].apply(window.console, arguments);
                }
            };
        });

        // Disable drag and drop (except for quiz drag items)
        document.addEventListener('dragstart', function (e) {
            if (!e.target.classList.contains('drag-item')) {
                e.preventDefault();
                return false;
            }
        });

        // Disable print
        window.addEventListener('beforeprint', function (e) {
            e.preventDefault();
            showSecurityWarning('Print dilarang semasa kuiz!');
            return false;
        });

        // Show security warning
        function showSecurityWarning(message) {
            // Remove existing warnings
            const existingWarnings = document.querySelectorAll('.security-warning');
            existingWarnings.forEach(warning => warning.remove());

            const warning = document.createElement('div');
            warning.className = 'security-warning fixed top-4 right-4 bg-red-600 text-white px-6 py-4 rounded-lg shadow-lg z-50 max-w-sm';
            warning.innerHTML = `
                <div class="flex items-center">
                    <div class="text-2xl mr-3">üö®</div>
                    <div>
                        <p class="font-bold">Amaran Keselamatan!</p>
                        <p class="text-sm">${message}</p>
                    </div>
                </div>
            `;

            document.body.appendChild(warning);

            // Auto remove after 5 seconds
            setTimeout(() => {
                if (warning.parentNode) {
                    warning.remove();
                }
            }, 5000);
        }

        // Show security overlay
        function showSecurityOverlay() {
            const overlay = document.getElementById('securityOverlay');
            if (overlay) {
                overlay.style.display = 'flex';
            }
        }

        // Hide security overlay
        function hideSecurityOverlay() {
            const overlay = document.getElementById('securityOverlay');
            if (overlay) {
                overlay.style.display = 'none';
            }
        }

        // Blur page when window loses focus (tab switching detection)
        let isPageVisible = true;

        document.addEventListener('visibilitychange', function () {
            if (document.hidden) {
                isPageVisible = false;
                showSecurityWarning('Tab switching dikesan! Fokus pada kuiz sahaja.');
            } else {
                isPageVisible = true;
            }
        });

        // Detect window focus/blur
        window.addEventListener('blur', function () {
            showSecurityWarning('Window focus hilang! Fokus pada kuiz sahaja.');
        });

        // Obfuscate quiz data in memory
        function obfuscateData(data) {
            return btoa(JSON.stringify(data));
        }

        function deobfuscateData(data) {
            try {
                return JSON.parse(atob(data));
            } catch (e) {
                return null;
            }
        }

        // üö® TUKAR URL INI SAHAJA! üö®
        // Gantikan dengan URL Google Apps Script anda
        const GOOGLE_SHEETS_URL = 'https://script.google.com/macros/s/AKfycbzbG7SEOT5H4beUdzObqi_nnUlnFrAWvx2oNKJkoxqWSDTTvIT6S7fERdnTDd7TqAE/exec';

        // Quiz data
        const quizData = {
            A: [
                {
                    type: 'multiple',
                    question: 'Gelaran Yang-di Pertuan besar hanya ada pada negeri',
                    options: ['Negeri Sembilan', 'Selangor', 'Kedah', 'Sabah'],
                    correct: [0]
                },
                {
                    type: 'multiple',
                    question: 'Apakah yang berlaku pada Institusi Raja bila Jepun menjajah tanah Melayu? (Pilih DUA jawapan)',
                    options: ['Raja ada kuasa mutlak', 'Raja kekal sebagai ketua negeri', 'Raja ketua agama islam', 'Raja dibantu oleh pembesar'],
                    correct: [1, 2],
                    multiSelect: true
                },
                {
                    type: 'multiple',
                    question: 'Apakah kepentingan penemuan batu bersurat?',
                    options: ['Kekayaan warisan sejarah', 'Undang-undang Islam', 'Titah perintah raja', 'Menandakan kedatangan Islam'],
                    correct: [3]
                },
                {
                    type: 'drag',
                    question: 'Bahasa Melayu merupakan bahasa yang mudah _________ dan bersifat _________ menjadikan ia mudah berkembang',
                    blanks: ['menerima unsur luar', 'terbuka'],
                    options: ['menerima unsur luar', 'diterima semua bangsa', 'tertutup', 'terbuka']
                },
                {
                    type: 'multiple',
                    question: 'Berikut merupakan cara-cara memupuk perpaduan dalam kalangan rakyat Malaysia KECUALI',
                    options: ['Pertandingan mendeklamasikan sajak', 'Pertandingan Pidato', 'Minggu Bahasa Kebangsaan', 'Pertandingan Melukis Poster'],
                    correct: [3]
                },
                {
                    type: 'multiple',
                    question: 'Bunga mas dihantar sebagai ufti kepada pemerintah Siam sebagai tanda persahabatan dan menjamin keselamatan. Bunga ini dihantar setiap',
                    options: ['3 minggu sekali', '3 bulan sekali', '3 tahun sekali', '3 hari sekali'],
                    correct: [2]
                },
                {
                    type: 'multiple',
                    question: 'Negara Y merupakan sebuah negara yang telah bangkit pada tahun 1942 dan telah berjaya menguasai hampir keseluruhan Tanah Melayu. Apakah negara Y?',
                    options: ['Siam', 'Jepun', 'Portugis', 'Belanda'],
                    correct: [1]
                },
                {
                    type: 'multiple',
                    question: 'Dato Maharaja Lela merupakan pejuang dari Negeri Perak. Perjuangan beliau menentang penjajah akhirnya telah menyebabkan beliau',
                    options: ['menyerah diri', 'dibuang negeri', 'Dihukum gantung', 'Dipenjara'],
                    correct: [2]
                },
                {
                    type: 'multiple',
                    question: 'Siapakah pejuang kemerdekaan yang menjadi Presiden pertama Malayan Chinese Association (MCA)?',
                    options: ['Dato\' Abdul Wahab', 'Tun Dr. Ismail', 'Tun Tan Cheng Lock', 'Tun Abdul Razak'],
                    correct: [2]
                },
                {
                    type: 'multiple',
                    question: 'Siapakah yang telah mereka cipta bendera Malaysia?',
                    options: ['Dato\' Onn Jaafar', 'En. Mohamed bin Hamzah', 'En. Jaafar bin Hamzah', 'En. Hamzah bin Muhammad'],
                    correct: [1]
                },
                {
                    type: 'multiple',
                    question: 'Siapakah yang memakai alat kebesaran diraja ini? (Rujuk gambar)',
                    imageUrl: 'https://i.imgur.com/d4o5VKC.png',
                    imageNote: 'Alat kebesaran diraja untuk Permaisuri',
                    options: ['Menteri besar', 'Perdana Menteri', 'Permaisuri Agong', 'Sultan'],
                    correct: [2]
                },
                {
                    type: 'multiple',
                    question: 'Alat kebesaran ini kebiasaan dijadikan hiasan pada tali pinggang atau bengkung. Apakah nama alat kebesaran tersebut?',
                    imageUrl: 'https://i.imgur.com/gD1K7DX.png',
                    imageNote: 'Alat kebesaran diraja untuk tali pinggang',
                    options: ['Muskat', 'Keris Pendek Diraja', 'Cogan Alam', 'Pending Diraja'],
                    correct: [3]
                },
                {
                    type: 'multiple',
                    question: 'Bagaimanakah pemilihan Yang di-Pertuan Agong dilakukan?',
                    options: ['Melalui pungutan suara', 'Melalui proses pengundian', 'Melalui Sistem Penggiliran', 'Melalui Sistem Pewarisan Takhta'],
                    correct: [2]
                },
                {
                    type: 'multiple',
                    question: 'Anda ternampak bendera Jalur Gemilang lusuh dan koyak, apakah yang anda akan lakukan untuk melupuskan bendera tersebut?',
                    options: ['Membakar secara tertutup', 'Membuang ke dalam tong sampah', 'Menyimpan di tempat yang selamat', 'Memberikan kepada pegawai keselamatan'],
                    correct: [0]
                },
                {
                    type: 'multiple',
                    question: 'Apakah maksud bendera separuh tiang?',
                    options: ['Tanda kejayaan', 'Tanda malapetak', 'Tanda berkabung', 'Tanda menyerah kalah'],
                    correct: [2]
                },
                {
                    type: 'truefalse',
                    question: 'Menurut Perlembagaan Persekutuan dalam Perkara 152, Bahasa Melayu dianggap sebagai Bahasa Kebangsaan.',
                    correct: true
                },
                {
                    type: 'multiple',
                    question: 'Anda datang lewat ke sekolah dan tiba-tiba anda terdengar lagu Negaraku. Apakah yang perlu anda buat? (Pilih DUA jawapan)',
                    options: ['Tangan diletakkan di dada', 'Letakkan beg di sisi kaki', 'Berhenti berjalan', 'Kedua-dua tangan di atas paha'],
                    correct: [1, 2],
                    multiSelect: true
                },
                {
                    type: 'multiple',
                    question: 'Lima kelopak yang ada pada Bunga Raya bermaksud',
                    imageUrl: 'https://i.imgur.com/i0CVws0.png',
                    imageNote: 'Bunga Raya - Bunga Kebangsaan Malaysia',
                    options: ['5 Rukun Islam', '5 Rukun Negara', '6 Rukun Iman', '5 Perlembagaan negara'],
                    correct: [1]
                },
                {
                    type: 'multiple',
                    question: 'Jata Negara juga merupakan simbol perpaduan, _____________ dan ___________ rakyat Malaysia',
                    options: ['kegemilangan ‚Ä¶. identiti', 'kemegahan ‚Ä¶. kekayaan', 'kemegahan ‚Ä¶. identiti', 'Ketegasan ‚Ä¶. identiti'],
                    correct: [2]
                },
                {
                    type: 'multiple',
                    question: 'Lambang Jata Negara boleh ditemui di tempat-tempat berikut KECUALI',
                    options: ['Kad Pengenalan', 'Bangunan Kerajaan', 'Passport', 'Kad Pekerja'],
                    correct: [3]
                },
                {
                    type: 'multiple',
                    question: 'Pengisytiharan kemerdekaan telah dibuat',
                    options: ['Lancaster House, London', 'Padang Bandar Hilir, Melaka', 'Istana Negara, Kuala Lumpur', 'Stadium Merdeka, Kuala Lumpur'],
                    correct: [3]
                },
                {
                    type: 'multiple',
                    question: 'Apakah pengajaran yang kita perolehi daripada penjajahan kuasa asing di negara kita?',
                    options: ['perlu memupuk semangat patriotik', 'perlu menerima pengaruh luar', 'perlu membuat kubu pertahanan', 'lupakan jasa pejuang negara'],
                    correct: [0]
                },
                {
                    type: 'multiple',
                    question: 'Nyatakan dua sumber perundangan yang terdapat pada zaman Kesultanan Melayu Melaka.',
                    options: ['Undang-undang Laut Melaka dan Hukum Kanun Pahang', 'Undang-undang 99 Perak dan Hukum Kanun Pahang', 'Undang-undang Laut Melaka dan Hukum Kanun Melaka', 'Undang-undang 99 Perak dan Hukum Kanun Melaka'],
                    correct: [2]
                },
                {
                    type: 'multiple',
                    question: 'Berikut merupakan peranan Bahasa Melayu pada masa dahulu dan kini, KECUALI',
                    options: ['bahasa rasmi', 'bahasa perpaduan', 'bahasa pendidikan', 'bahasa perjuangan'],
                    correct: [3]
                },
                {
                    type: 'multiple',
                    question: 'Ini adalah pakaian RASMI yang dipakai oleh Seri Paduka Baginda Yang di-Pertuan Agong (RUJUK GAMBAR). Apakah nama pakaian tersebut?',
                    imageUrl: 'https://i.imgur.com/0soPGXA.png',
                    imageNote: 'Pakaian rasmi Yang di-Pertuan Agong',
                    options: ['Muskat', 'Gandik Diraja', 'Pending Diraja', 'Pakaian Diraja'],
                    correct: [0]
                },
                {
                    type: 'multiple',
                    question: 'Yang di-Pertuan Agong memayungi tiga Badan Kerajaan seperti dalam rajah. Apakah X, Y dan Z? (Rujuk Gambar)',
                    imageUrl: 'https://i.imgur.com/jvsCoUj.png',
                    imageNote: 'Carta organisasi tiga badan kerajaan',
                    options: ['Perundangan, Eksekutif dan Perniagaan', 'Perundangan, Pemasaran dan Kehakiman', 'Perundangan, Hubungan Luar dan Kehakiman', 'Perundangan, Eksekutif dan Kehakiman'],
                    correct: [3]
                },
                {
                    type: 'multiple',
                    question: 'Apakah yang dimaksudkan dengan peranan bahasa kebangsaan sebagai bahasa pentadbiran?',
                    options: ['Bahasa kebangsaan digunakan dalam kegiatan ekonomi.', 'Bahasa kebangsaan merupakan bahasa penghantar.', 'Bahasa kebangsaan digunakan dalam urusan rasmi.', 'Masyarakat berbilang kaum memerlukan satu bahasa yang di fahami oleh semua kaum.'],
                    correct: [2]
                },
                {
                    type: 'multiple',
                    question: 'Siapakah yang mengurus pentadbiran negeri-negeri Melayu semasa zaman pendudukan Jepun?',
                    options: ['Penasihat British', 'Gabenor Jepun', 'Sultan', 'Para pembesar'],
                    correct: [1]
                },
                {
                    type: 'multiple',
                    question: 'Bahasa Melayu berasal dari rumpun',
                    options: ['Australia', 'Malaysia', 'Indonesia', 'Austronesia'],
                    correct: [3]
                },
                {
                    type: 'multiple',
                    question: 'Berikut menunjukkan cara kita memupuk perpaduan antara kaum dengan pelbagai agama KECUALI',
                    options: ['Tidak melarang upacara keagamaan kaum lain', 'Tidak menghormati agama dan kepercayaan kaum lain', 'Menghormati tempat ibadat kaum lain', 'Bersikap toleransi dengan penganut agama lain'],
                    correct: [1]
                }
            ],
            B: [
                {
                    type: 'fillblanks',
                    question: 'Soalan 1: Isikan tempat kosong dengan jawapan yang sesuai.',
                    points: 5,
                    guidelines: 'Seret jawapan yang betul ke tempat kosong yang sesuai.',
                    blanks: [
                        { text: 'A. Kedatangan para pedagang dari Tanah Arab, ____________ dan Parsi yang berdakwah dan menyebarkan agama Islam di Melaka.', answer: 'India' },
                        { text: 'B. Menurut Hikayat Raja-raja Pasai, agama Islam disebarkan di Melaka oleh Ulama dari Mekah yang bernama _____________.', answer: 'Syeikh Abdul Aziz' },
                        { text: 'C. Ulama tersebut telah mengislamkan raja, ________________ dan rakyat Melaka.', answer: 'pembesar' },
                        { text: 'D. Sultan Melaka iaitu _______________ telah berkahwin dengan Puteri Raja Pasai dan baginda memeluk agama Islam.', answer: 'Megat Iskandar Shah' },
                        { text: 'E. Pengislaman Sultan Melaka telah diikuti oleh pembesar dan _____________.', answer: 'rakyat' }
                    ],
                    options: ['India', 'pembesar', 'Megat Iskandar Shah', 'rakyat', 'Syeikh Abdul Aziz', 'Sultan Abdullah']
                },
                {
                    type: 'matching',
                    question: 'Soalan 2: Padankan warna dan lambang Jalur Gemilang dengan makna yang betul.',
                    points: 5,
                    guidelines: 'Seret setiap warna/lambang ke makna yang sesuai.',
                    pairs: [
                        { left: 'Kuning', right: 'Kesetiaan pada raja dan negara' },
                        { left: 'Biru', right: 'Perpaduan rakyat' },
                        { left: 'Merah', right: 'Keberanian rakyat hadapi cabaran' },
                        { left: 'Putih', right: 'Kesucian' },
                        { left: 'Bulan Sabit', right: 'Agama Islam agama Persekutuan' }
                    ]
                }
            ],
            C: [
                {
                    type: 'shortanswer',
                    question: 'Soalan 1 (a) Islam telah berkembang semasa Zaman Kesultanan Melayu Melaka, bagaimanakah agama Islam boleh tersebar?',
                    points: 2,
                    guidelines: 'Jawapan hendaklah menyebut cara penyebaran Islam.',
                    keywords: ['dakwah', 'perkahwinan'],
                    scoring: 'simple',
                    teacherAnswer: `
                        <div class="space-y-4">
                            <div class="bg-green-50 p-4 rounded-lg border-l-4 border-green-400">
                                <h5 class="font-bold text-green-800 mb-2">Jawapan Lengkap:</h5>
                                <ul class="list-disc list-inside space-y-1 text-green-700">
                                    <li><strong>Dakwah</strong> - Para ulama dan pedagang Muslim menyebarkan ajaran Islam</li>
                                    <li><strong>Perkahwinan</strong> - Melalui perkahwinan antara pedagang Muslim dengan penduduk tempatan</li>
                                </ul>
                            </div>
                        </div>
                    `
                },
                {
                    type: 'shortanswer',
                    question: 'Soalan 1 (b) Sebagai seorang murid yang mempelajari Sejarah, kenapa kita perlu menghormati agama lain yang ada di Malaysia?',
                    points: 3,
                    guidelines: 'Jawapan hendaklah menjelaskan kepentingan menghormati agama lain.',
                    keywords: {
                        'Perpaduan/Harmoni': {
                            weight: 1,
                            words: ['perpaduan', 'bersatu', 'harmoni', 'muafakat', 'kebersamaan', 'integrasi', 'kohesi sosial', 'kerjasama', 'saling memahami']
                        },
                        'Elak Konflik/Salah faham': {
                            weight: 1,
                            words: ['elak', 'mengelakkan', 'menghindari', 'kurangkan', 'mencegah', 'konflik', 'pergaduhan', 'ketegangan', 'salah faham', 'prasangka']
                        },
                        'Nilai Murni/Rukun Negara': {
                            weight: 1,
                            words: ['nilai murni', 'adab', 'kesopanan', 'kesusilaan', 'toleransi', 'hormat-menghormati', 'empati', 'rukun negara', 'kesopanan dan kesusilaan']
                        }
                    },
                    scoring: 'weighted',
                    teacherAnswer: `
                        <div class="space-y-4">
                            <div class="bg-green-50 p-4 rounded-lg border-l-4 border-green-400">
                                <h5 class="font-bold text-green-800 mb-2">Jawapan Lengkap:</h5>
                                <ul class="list-disc list-inside space-y-1 text-green-700">
                                    <li><strong>Perpaduan dan Harmoni</strong> - Mengekalkan keharmonian dalam masyarakat berbilang kaum</li>
                                    <li><strong>Mengelakkan Konflik</strong> - Mencegah salah faham dan ketegangan antara kaum</li>
                                    <li><strong>Nilai Murni</strong> - Mengamalkan toleransi dan kesopanan seperti dalam Rukun Negara</li>
                                </ul>
                            </div>
                        </div>
                    `
                },
                {
                    type: 'shortanswer',
                    question: 'Soalan 2 (a) Sebutkan dua buah wilayah/negara yang pernah menuturkan Bahasa Melayu.',
                    points: 2,
                    guidelines: 'Sebutkan mana-mana dua negara/wilayah.',
                    keywords: ['indonesia', 'selatan thailand', 'filipina', 'brunei', 'singapura', 'kemboja', 'vietnam', 'afrika selatan', 'sri lanka', 'pulau cocos', 'madagaskar', 'new zealand', 'pulau easter', 'arab saudi', 'pulau krismas', 'australia barat'],
                    scoring: 'countries',
                    teacherAnswer: `
                        <div class="space-y-4">
                            <div class="bg-green-50 p-4 rounded-lg border-l-4 border-green-400">
                                <h5 class="font-bold text-green-800 mb-2">Jawapan Lengkap (Pilih mana-mana 2):</h5>
                                <div class="grid grid-cols-2 gap-2 text-green-700 text-sm">
                                    <ul class="list-disc list-inside space-y-1">
                                        <li>Indonesia</li>
                                        <li>Selatan Thailand</li>
                                        <li>Filipina</li>
                                        <li>Brunei</li>
                                        <li>Singapura</li>
                                        <li>Kemboja</li>
                                        <li>Vietnam</li>
                                        <li>Afrika Selatan</li>
                                    </ul>
                                    <ul class="list-disc list-inside space-y-1">
                                        <li>Sri Lanka</li>
                                        <li>Pulau Cocos</li>
                                        <li>Madagaskar</li>
                                        <li>New Zealand</li>
                                        <li>Pulau Easter</li>
                                        <li>Arab Saudi</li>
                                        <li>Pulau Krismas</li>
                                        <li>Australia Barat</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    `
                },
                {
                    type: 'shortanswer',
                    question: 'Soalan 2 (b) Apakah aktiviti yang boleh dilaksanakan sempena Sambutan Bulan Bahasa untuk meningkatkan kemahiran murid dalam Berbahasa Melayu?',
                    points: 3,
                    guidelines: 'Berikan contoh aktiviti yang sesuai.',
                    keywords: {
                        'Pertandingan nyanyian lagu patriotik': {
                            weight: 1,
                            words: ['pertandingan nyanyian lagu patriotik', 'nyanyian lagu patriotik', 'lagu patriotik', 'nyanyian patriotik']
                        },
                        'Persembahan drama kemerdekaan': {
                            weight: 1,
                            words: ['persembahan drama kemerdekaan', 'drama kemerdekaan', 'persembahan drama', 'teater kemerdekaan']
                        },
                        'Pertandingan mendeklamasikan sajak': {
                            weight: 1,
                            words: ['pertandingan mendeklamasikan sajak', 'deklamasi sajak', 'mendeklamasikan sajak', 'pertandingan sajak', 'deklamasi']
                        }
                    },
                    scoring: 'weighted',
                    teacherAnswer: `
                        <div class="space-y-4">
                            <div class="bg-green-50 p-4 rounded-lg border-l-4 border-green-400">
                                <h5 class="font-bold text-green-800 mb-2">Jawapan Lengkap:</h5>
                                <ol class="list-decimal list-inside space-y-2 text-green-700">
                                    <li><strong>Pertandingan nyanyian lagu patriotik</strong> yang disertai oleh murid pelbagai kaum menggunakan bahasa Melayu.</li>
                                    <li><strong>Persembahan drama kemerdekaan</strong> menggunakan bahasa Melayu.</li>
                                    <li><strong>Pertandingan mendeklamasikan sajak</strong> menggunakan bahasa Melayu.</li>
                                    <li>Mana-mana jawapan yang munasabah yang berkait dengan bahasa Melayu boleh diterima.</li>
                                </ol>
                            </div>
                            <div class="bg-blue-50 p-4 rounded-lg border-l-4 border-blue-400">
                                <h5 class="font-bold text-blue-800 mb-2">Nota Guru:</h5>
                                <p class="text-blue-700 text-sm">Aktiviti-aktiviti ini membantu murid menggunakan bahasa Melayu secara aktif dan kreatif, sambil memupuk semangat patriotik dan perpaduan.</p>
                            </div>
                        </div>
                    `
                }
            ]
        };

        // Quiz state
        let currentSection = '';
        let currentQuestions = [];
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let score = 0;
        let totalScore = 0;
        let maxScore = 0;
        let studentInfo = {
            name: '',
            class: '',
            school: ''
        };
        let sectionScores = {
            A: { score: 0, max: 30 },
            B: { score: 0, max: 10 },
            C: { score: 0, max: 10 }
        };
        let mistakes = [];
        let completedSections = [];

        // Submit student information
        function submitStudentInfo() {
            const name = document.getElementById('studentName').value.trim();
            const studentClass = document.getElementById('studentClass').value.trim();
            const school = document.getElementById('studentSchool').value.trim();

            if (!name || !studentClass || !school) {
                showInlineMessage('Sila isi semua maklumat yang diperlukan.', 'error');
                return;
            }

            studentInfo.name = name;
            studentInfo.class = studentClass;
            studentInfo.school = school;

            document.getElementById('studentInfoForm').classList.add('hidden');
            document.getElementById('mainMenu').classList.remove('hidden');
        }

        // Show inline message instead of alert
        function showInlineMessage(message, type = 'info') {
            // Remove existing messages
            const existingMessages = document.querySelectorAll('.inline-message');
            existingMessages.forEach(msg => msg.remove());

            const messageDiv = document.createElement('div');
            messageDiv.className = `inline-message mt-4 p-4 rounded-lg border ${type === 'error' ? 'bg-red-100 border-red-400 text-red-700' :
                type === 'success' ? 'bg-green-100 border-green-400 text-green-700' :
                    'bg-blue-100 border-blue-400 text-blue-700'
                }`;
            messageDiv.innerHTML = `
                <div class="flex items-center">
                    <div class="text-2xl mr-3">${type === 'error' ? '‚ö†Ô∏è' : type === 'success' ? '‚úÖ' : '‚ÑπÔ∏è¬è'}</div>
                    <p>${message}</p>
                </div>
            `;

            // Insert after the form
            const form = document.getElementById('studentInfoForm');
            if (form && !form.classList.contains('hidden')) {
                form.appendChild(messageDiv);
            }

            // Auto remove after 5 seconds
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.remove();
                }
            }, 5000);
        }

        // Shuffle array function
        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        // Start quiz section
        function startSection(section) {
            currentSection = section;
            currentQuestions = shuffleArray([...quizData[section]]);

            // Shuffle options for multiple choice questions and matching pairs
            currentQuestions.forEach(q => {
                if (q.type === 'multiple' || q.type === 'drag') {
                    const originalOptions = [...q.options];
                    const shuffledOptions = shuffleArray(originalOptions);

                    // Update correct answers indices
                    if (q.correct) {
                        q.correct = q.correct.map(correctIndex =>
                            shuffledOptions.indexOf(originalOptions[correctIndex])
                        );
                    }

                    q.options = shuffledOptions;
                } else if (q.type === 'matching') {
                    // Shuffle the pairs for matching questions
                    q.pairs = shuffleArray([...q.pairs]);
                }
            });

            currentQuestionIndex = 0;
            userAnswers = [];
            score = 0;

            document.getElementById('mainMenu').classList.add('hidden');
            document.getElementById('quizContainer').classList.remove('hidden');

            updateProgress();
            displayQuestion();
        }

        // Update progress bar
        function updateProgress() {
            const progress = ((currentQuestionIndex + 1) / currentQuestions.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('progressText').textContent = `${currentQuestionIndex + 1} / ${currentQuestions.length}`;
        }

        // Display current question
        function displayQuestion() {
            const question = currentQuestions[currentQuestionIndex];
            const questionContent = document.getElementById('questionContent');

            let html = `<h3 class="text-lg sm:text-xl font-bold text-gray-800 mb-6">Soalan ${currentQuestionIndex + 1}</h3>`;

            if (question.type === 'multiple') {
                html += `<p class="text-base sm:text-lg text-gray-700 mb-6">${question.question}</p>`;

                // Add image if exists
                if (question.imageUrl) {
                    html += `
                        <div class="mb-6 p-4 bg-blue-50 border-l-4 border-blue-400 rounded-r-lg">
                            <div class="flex items-start">
                                <div class="text-2xl mr-3">üñºÔ∏è¬è</div>
                                <div class="flex-1">
                                    <p class="text-blue-800 font-medium mb-3">Rujukan Gambar:</p>
                                    <div class="bg-white p-3 rounded-lg border border-blue-200">
                                        <img src="${question.imageUrl}" alt="${question.imageNote}" 
                                             class="max-w-full h-auto rounded-lg shadow-sm mx-auto block"
                                             style="max-height: 300px;"
                                             onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                        <div class="hidden text-center p-4 text-gray-500">
                                            <div class="text-4xl mb-2">üñºÔ∏è¬è</div>
                                            <p class="text-sm">${question.imageNote}</p>
                                            <p class="text-xs text-gray-400 mt-1">Gambar tidak dapat dimuatkan</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                } else if (question.imageNote) {
                    html += `
                        <div class="mb-6 p-4 bg-blue-50 border-l-4 border-blue-400 rounded-r-lg">
                            <div class="flex items-center">
                                <div class="text-2xl mr-3">üñºÔ∏è¬è</div>
                                <div>
                                    <p class="text-blue-800 font-medium">Rujukan Gambar:</p>
                                    <p class="text-blue-700 text-sm">${question.imageNote}</p>
                                </div>
                            </div>
                        </div>
                    `;
                }

                if (question.multiSelect) {
                    html += `<p class="text-sm text-blue-600 mb-4">üí° Pilih lebih daripada satu jawapan</p>`;
                }

                html += '<div class="space-y-3">';
                question.options.forEach((option, index) => {
                    const inputType = question.multiSelect ? 'checkbox' : 'radio';
                    const inputName = question.multiSelect ? `q${currentQuestionIndex}_${index}` : `q${currentQuestionIndex}`;

                    html += `
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg hover:border-emerald-300 hover:bg-emerald-50 cursor-pointer transition-all duration-300">
                            <input type="${inputType}" name="${inputName}" value="${index}" class="mr-4 w-5 h-5 text-emerald-600">
                            <span class="text-gray-700">${String.fromCharCode(65 + index)}. ${option}</span>
                        </label>
                    `;
                });
                html += '</div>';

            } else if (question.type === 'truefalse') {
                html += `<p class="text-base sm:text-lg text-gray-700 mb-6">${question.question}</p>`;
                html += '<div class="space-y-4">';
                html += `
                    <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg hover:border-green-300 hover:bg-green-50 cursor-pointer transition-all duration-300">
                        <input type="radio" name="q${currentQuestionIndex}" value="true" class="mr-4 w-5 h-5 text-green-600">
                        <span class="text-gray-700 font-medium">‚úî BETUL</span>
                    </label>
                    <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg hover:border-red-300 hover:bg-red-50 cursor-pointer transition-all duration-300">
                        <input type="radio" name="q${currentQuestionIndex}" value="false" class="mr-4 w-5 h-5 text-red-600">
                        <span class="text-gray-700 font-medium">‚úó SALAH</span>
                    </label>
                `;
                html += '</div>';

            } else if (question.type === 'drag') {
                html += `<p class="text-base sm:text-lg text-gray-700 mb-6">${question.question}</p>`;
                html += `<p class="text-sm text-blue-600 mb-4">üí° Seret jawapan ke tempat yang betul</p>`;

                // Create blanks
                html += '<div class="mb-4 sm:mb-6 space-y-3 sm:space-y-4">';
                question.blanks.forEach((blank, index) => {
                    html += `
                        <div class="flex items-center space-x-4">
                            <span class="text-gray-700 font-medium">Tempat ${index + 1}:</span>
                            <div class="drop-zone flex-1 p-4 rounded-lg border-2 border-dashed border-gray-300" data-blank="${index}">
                                <span class="text-gray-400">Letakkan jawapan di sini</span>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';

                // Create draggable options
                html += '<div class="grid grid-cols-2 gap-2 sm:gap-3">';
                question.options.forEach((option, index) => {
                    html += `
                        <div class="drag-item bg-blue-100 border-2 border-blue-300 p-3 rounded-lg text-center cursor-grab hover:bg-blue-200 transition-colors duration-300" draggable="true" data-option="${option}">
                            ${option}
                        </div>
                    `;
                });
                html += '</div>';

            } else if (question.type === 'shortanswer') {
                html += `<p class="text-base sm:text-lg text-gray-700 mb-4">${question.question}</p>`;
                html += `<p class="text-sm text-blue-600 mb-4">üìù¬ù Markah: ${question.points}</p>`;
                html += `<p class="text-sm text-gray-600 mb-6"><strong>Panduan:</strong> ${question.guidelines}</p>`;
                html += `
                    <textarea 
                        id="shortAnswer" 
                        class="w-full h-32 p-4 border-2 border-gray-300 rounded-lg focus:border-emerald-500 focus:outline-none resize-none" 
                        placeholder="Tulis jawapan anda di sini..."
                    ></textarea>
                `;
            } else if (question.type === 'fillblanks') {
                html += `<p class="text-base sm:text-lg text-gray-700 mb-4">${question.question}</p>`;
                html += `<p class="text-sm text-blue-600 mb-4">üìù¬ù Markah: ${question.points}</p>`;
                html += `<p class="text-sm text-gray-600 mb-4"><strong>Panduan:</strong> ${question.guidelines}</p>`;
                html += `<p class="text-sm text-blue-600 mb-6">üí° Seret jawapan yang betul ke tempat kosong</p>`;

                // Display blanks
                html += '<div class="space-y-4 mb-6">';
                question.blanks.forEach((blank, index) => {
                    const blankText = blank.text.replace('____________', `<span class="drop-zone-blank inline-block min-w-32 mx-2 px-3 py-1 border-2 border-dashed border-gray-400 rounded bg-gray-50 text-center" data-blank="${index}">_____</span>`);
                    html += `
                        <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
                            <p class="text-gray-800">${blankText}</p>
                        </div>
                    `;
                });
                html += '</div>';

                // Display options
                html += '<div class="grid grid-cols-2 md:grid-cols-3 gap-2 sm:gap-3">';
                question.options.forEach((option, index) => {
                    html += `
                        <div class="drag-item bg-blue-100 border-2 border-blue-300 p-3 rounded-lg text-center cursor-grab hover:bg-blue-200 transition-colors duration-300" draggable="true" data-option="${option}">
                            ${option}
                        </div>
                    `;
                });
                html += '</div>';

            } else if (question.type === 'matching') {
                html += `<p class="text-base sm:text-lg text-gray-700 mb-4">${question.question}</p>`;
                html += `<p class="text-sm text-blue-600 mb-4">üìù Markah: ${question.points}</p>`;
                html += `<p class="text-sm text-gray-600 mb-4"><strong>Panduan:</strong> ${question.guidelines}</p>`;
                html += `<p class="text-sm text-blue-600 mb-6">üí° Seret item dari sebelah kiri ke kotak yang sesuai di sebelah kanan</p>`;

                html += '<div class="grid grid-cols-1 md:grid-cols-2 gap-8">';

                // Left column - draggable items
                html += '<div class="space-y-3">';
                html += '<h4 class="font-bold text-gray-800 mb-4">Warna/Lambang:</h4>';
                question.pairs.forEach((pair, index) => {
                    html += `
                        <div class="drag-item bg-yellow-100 border-2 border-yellow-300 p-3 rounded-lg text-center cursor-grab hover:bg-yellow-200 transition-colors duration-300" draggable="true" data-match="${pair.left}">
                            ${pair.left}
                        </div>
                    `;
                });
                html += '</div>';

                // Right column - drop zones
                html += '<div class="space-y-3">';
                html += '<h4 class="font-bold text-gray-800 mb-4">Makna:</h4>';
                question.pairs.forEach((pair, index) => {
                    html += `
                        <div class="flex items-center space-x-3">
                            <div class="drop-zone-match flex-1 p-3 rounded-lg border-2 border-dashed border-gray-300 min-h-12 flex items-center" data-answer="${pair.right}">
                                <span class="text-gray-400 text-sm">Letakkan jawapan di sini</span>
                            </div>
                            <div class="w-1/2 text-sm text-gray-700 bg-gray-50 p-3 rounded-lg">
                                ${pair.right}
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                html += '</div>';
            }

            questionContent.innerHTML = html;

            // Setup drag and drop for drag questions
            if (question.type === 'drag') {
                setupDragAndDrop();
            } else if (question.type === 'matching') {
                setupMatchingDragAndDrop();
            } else if (question.type === 'fillblanks') {
                setupFillBlanksDragAndDrop();
            }

            // Load previous answer if exists
            loadPreviousAnswer();

            // Update navigation buttons
            updateNavigationButtons();
        }

        // [DUPLICATE CODE REMOVED - startSection, updateProgress, displayQuestion functions were duplicated here]
        // The original correct versions are above

        // Placeholder to mark removed duplicate code
        /* DUPLICATE FUNCTIONS REMOVED - START

            // Shuffle options for multiple choice questions and matching pairs
            currentQuestions.forEach(q => {
                if (q.type === 'multiple' || q.type === 'drag') {
                    const originalOptions = [...q.options];
                    const shuffledOptions = shuffleArray(originalOptions);

                    // Update correct answers indices
                    if (q.correct) {
                        q.correct = q.correct.map(correctIndex =>
                            shuffledOptions.indexOf(originalOptions[correctIndex])
                        );
                    }

                    q.options = shuffledOptions;
                } else if (q.type === 'matching') {
                    // Shuffle the pairs for matching questions
                    q.pairs = shuffleArray([...q.pairs]);
                }
            });

            currentQuestionIndex = 0;
            userAnswers = [];
            score = 0;

            document.getElementById('mainMenu').classList.add('hidden');
            document.getElementById('quizContainer').classList.remove('hidden');

            updateProgress();
            displayQuestion();
        }

        // Update progress bar
        function updateProgress() {
            const progress = ((currentQuestionIndex + 1) / currentQuestions.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('progressText').textContent = `${ currentQuestionIndex + 1 } / ${currentQuestions.length}`;
                }

        // Display current question
        function displayQuestion() {
                        const question = currentQuestions[currentQuestionIndex];
                        const questionContent = document.getElementById('questionContent');

                        let html = `<h3 class="text-lg sm:text-xl font-bold text-gray-800 mb-6">Soalan ${currentQuestionIndex + 1}</h3>`;

                        if (question.type === 'multiple') {
                            html += `<p class="text-base sm:text-lg text-gray-700 mb-6">${question.question}</p>`;

                            // Add image if exists
                            if (question.imageUrl) {
                                html += `
                        <div class="mb-6 p-4 bg-blue-50 border-l-4 border-blue-400 rounded-r-lg">
                            <div class="flex items-start">
                                <div class="text-2xl mr-3">üñºÔ∏è¬è</div>
                                <div class="flex-1">
                                    <p class="text-blue-800 font-medium mb-3">Rujukan Gambar:</p>
                                    <div class="bg-white p-3 rounded-lg border border-blue-200">
                                        <img src="${question.imageUrl}" alt="${question.imageNote}" 
                                             class="max-w-full h-auto rounded-lg shadow-sm mx-auto block"
                                             style="max-height: 300px;"
                                             onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                        <div class="hidden text-center p-4 text-gray-500">
                                            <div class="text-4xl mb-2">üñºÔ∏è¬è</div>
                                            <p class="text-sm">${question.imageNote}</p>
                                            <p class="text-xs text-gray-400 mt-1">Gambar tidak dapat dimuatkan</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                            } else if (question.imageNote) {
                                html += `
                        <div class="mb-6 p-4 bg-blue-50 border-l-4 border-blue-400 rounded-r-lg">
                            <div class="flex items-center">
                                <div class="text-2xl mr-3">üñºÔ∏è¬è</div>
                                <div>
                                    <p class="text-blue-800 font-medium">Rujukan Gambar:</p>
                                    <p class="text-blue-700 text-sm">${question.imageNote}</p>
                                </div>
                            </div>
                        </div>
                    `;
                            }

                            if (question.multiSelect) {
                                html += `<p class="text-sm text-blue-600 mb-4">üí° Pilih lebih daripada satu jawapan</p>`;
                            }

                            html += '<div class="space-y-3">';
                            question.options.forEach((option, index) => {
                                const inputType = question.multiSelect ? 'checkbox' : 'radio';
                                const inputName = question.multiSelect ? `q${currentQuestionIndex}_${index}` : `q${currentQuestionIndex}`;

                                html += `
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg hover:border-emerald-300 hover:bg-emerald-50 cursor-pointer transition-all duration-300">
                            <input type="${inputType}" name="${inputName}" value="${index}" class="mr-4 w-5 h-5 text-emerald-600">
                            <span class="text-gray-700">${String.fromCharCode(65 + index)}. ${option}</span>
                        </label>
                    `;
                            });
                            html += '</div>';

                        } else if (question.type === 'truefalse') {
                            html += `<p class="text-base sm:text-lg text-gray-700 mb-6">${question.question}</p>`;
                            html += '<div class="space-y-4">';
                            html += `
                    <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg hover:border-green-300 hover:bg-green-50 cursor-pointer transition-all duration-300">
                        <input type="radio" name="q${currentQuestionIndex}" value="true" class="mr-4 w-5 h-5 text-green-600">
                        <span class="text-gray-700 font-medium">‚úî BETUL</span>
                    </label>
                    <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg hover:border-red-300 hover:bg-red-50 cursor-pointer transition-all duration-300">
                        <input type="radio" name="q${currentQuestionIndex}" value="false" class="mr-4 w-5 h-5 text-red-600">
                        <span class="text-gray-700 font-medium">‚úó SALAH</span>
                    </label>
                `;
                            html += '</div>';

                        } else if (question.type === 'drag') {
                            html += `<p class="text-base sm:text-lg text-gray-700 mb-6">${question.question}</p>`;
                            html += `<p class="text-sm text-blue-600 mb-4">üí° Seret jawapan ke tempat yang betul</p>`;

                            // Create blanks
                            html += '<div class="mb-4 sm:mb-6 space-y-3 sm:space-y-4">';
                            question.blanks.forEach((blank, index) => {
                                html += `
                        <div class="flex items-center space-x-4">
                            <span class="text-gray-700 font-medium">Tempat ${index + 1}:</span>
                            <div class="drop-zone flex-1 p-4 rounded-lg border-2 border-dashed border-gray-300" data-blank="${index}">
                                <span class="text-gray-400">Letakkan jawapan di sini</span>
                            </div>
                        </div>
                    `;
                            });
                            html += '</div>';

                            // Create draggable options
                            html += '<div class="grid grid-cols-2 gap-2 sm:gap-3">';
                            question.options.forEach((option, index) => {
                                html += `
                        <div class="drag-item bg-blue-100 border-2 border-blue-300 p-3 rounded-lg text-center cursor-grab hover:bg-blue-200 transition-colors duration-300" draggable="true" data-option="${option}">
                            ${option}
                        </div>
                    `;
                            });
                            html += '</div>';

                        } else if (question.type === 'shortanswer') {
                            html += `<p class="text-base sm:text-lg text-gray-700 mb-4">${question.question}</p>`;
                            html += `<p class="text-sm text-blue-600 mb-4">üìù¬ù Markah: ${question.points}</p>`;
                            html += `<p class="text-sm text-gray-600 mb-6"><strong>Panduan:</strong> ${question.guidelines}</p>`;
                            html += `
                    <textarea 
                        id="shortAnswer" 
                        class="w-full h-32 p-4 border-2 border-gray-300 rounded-lg focus:border-emerald-500 focus:outline-none resize-none" 
                        placeholder="Tulis jawapan anda di sini..."
                    ></textarea>
                `;
                        } else if (question.type === 'fillblanks') {
                            html += `<p class="text-base sm:text-lg text-gray-700 mb-4">${question.question}</p>`;
                            html += `<p class="text-sm text-blue-600 mb-4">üìù¬ù Markah: ${question.points}</p>`;
                            html += `<p class="text-sm text-gray-600 mb-4"><strong>Panduan:</strong> ${question.guidelines}</p>`;
                            html += `<p class="text-sm text-blue-600 mb-6">üí° Seret jawapan yang betul ke tempat kosong</p>`;

                            // Display blanks
                            html += '<div class="space-y-4 mb-6">';
                            question.blanks.forEach((blank, index) => {
                                const blankText = blank.text.replace('____________', `<span class="drop-zone-blank inline-block min-w-32 mx-2 px-3 py-1 border-2 border-dashed border-gray-400 rounded bg-gray-50 text-center" data-blank="${index}">_____</span>`);
                                html += `
                        <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
                            <p class="text-gray-800">${blankText}</p>
                        </div>
                    `;
                            });
                            html += '</div>';

                            // Display options
                            html += '<div class="grid grid-cols-2 md:grid-cols-3 gap-2 sm:gap-3">';
                            question.options.forEach((option, index) => {
                                html += `
                        <div class="drag-item bg-blue-100 border-2 border-blue-300 p-3 rounded-lg text-center cursor-grab hover:bg-blue-200 transition-colors duration-300" draggable="true" data-option="${option}">
                            ${option}
                        </div>
                    `;
                            });
                            html += '</div>';

                        } else if (question.type === 'matching') {
                            html += `<p class="text-base sm:text-lg text-gray-700 mb-4">${question.question}</p>`;
                            html += `<p class="text-sm text-blue-600 mb-4">üìù¬ù Markah: ${question.points}</p>`;
                            html += `<p class="text-sm text-gray-600 mb-4"><strong>Panduan:</strong> ${question.guidelines}</p>`;
                            html += `<p class="text-sm text-blue-600 mb-6">üí° Seret item dari sebelah kiri ke kotak yang sesuai di sebelah kanan</p>`;

                            html += '<div class="grid grid-cols-1 md:grid-cols-2 gap-8">';

                            // Left column - draggable items
                            html += '<div class="space-y-3">';
                            html += '<h4 class="font-bold text-gray-800 mb-4">Warna/Lambang:</h4>';
                            question.pairs.forEach((pair, index) => {
                                html += `
                        <div class="drag-item bg-yellow-100 border-2 border-yellow-300 p-3 rounded-lg text-center cursor-grab hover:bg-yellow-200 transition-colors duration-300" draggable="true" data-match="${pair.left}">
                            ${pair.left}
                        </div>
                    `;
                            });
                            html += '</div>';

                            // Right column - drop zones
                            html += '<div class="space-y-3">';
                            html += '<h4 class="font-bold text-gray-800 mb-4">Makna:</h4>';
                            question.pairs.forEach((pair, index) => {
                                html += `
                        <div class="flex items-center space-x-3">
                            <div class="drop-zone-match flex-1 p-3 rounded-lg border-2 border-dashed border-gray-300 min-h-12 flex items-center" data-answer="${pair.right}">
                                <span class="text-gray-400 text-sm">Letakkan jawapan di sini</span>
                            </div>
                            <div class="w-1/2 text-sm text-gray-700 bg-gray-50 p-3 rounded-lg">
                                ${pair.right}
                            </div>
                        </div>
                    `;
                            });
                            html += '</div>';
                            html += '</div>';
                        }

                        questionContent.innerHTML = html;

                        // Setup drag and drop for drag questions
                        if (question.type === 'drag') {
                            setupDragAndDrop();
                        } else if (question.type === 'matching') {
                            setupMatchingDragAndDrop();
                        } else if (question.type === 'fillblanks') {
                            setupFillBlanksDragAndDrop();
                        }

                        // Load previous answer if exists
                        loadPreviousAnswer();

                        // Update navigation buttons
                        updateNavigationButtons();
                    }
        DUPLICATE FUNCTIONS REMOVED - END */

        // Helper for Touch Events (Mobile Support)
        function enableTouchDrag(dragItems, dropZones, sourceDataAttr, targetDataAttr) {
                        let touchDragItem = null;

                        dragItems.forEach(item => {
                            item.addEventListener('touchstart', (e) => {
                                // Prevent default only if it's a drag action to allow scrolling elsewhere
                                // But for drag items we want to prevent scrolling
                                e.preventDefault();
                                const touch = e.touches[0];
                                touchDragItem = item.cloneNode(true);
                                touchDragItem.classList.add('fixed', 'z-50', 'opacity-80', 'pointer-events-none');
                                touchDragItem.style.width = item.offsetWidth + 'px';
                                touchDragItem.style.left = (touch.clientX - item.offsetWidth / 2) + 'px';
                                touchDragItem.style.top = (touch.clientY - item.offsetHeight / 2) + 'px';
                                document.body.appendChild(touchDragItem);
                                item.classList.add('opacity-50');
                            }, { passive: false });

                            item.addEventListener('touchmove', (e) => {
                                if (!touchDragItem) return;
                                e.preventDefault();
                                const touch = e.touches[0];
                                touchDragItem.style.left = (touch.clientX - touchDragItem.offsetWidth / 2) + 'px';
                                touchDragItem.style.top = (touch.clientY - touchDragItem.offsetHeight / 2) + 'px';
                            }, { passive: false });

                            item.addEventListener('touchend', (e) => {
                                if (!touchDragItem) return;
                                const touch = e.changedTouches[0];
                                touchDragItem.remove();
                                touchDragItem = null;
                                item.classList.remove('opacity-50');

                                const dropTarget = document.elementFromPoint(touch.clientX, touch.clientY);
                                if (!dropTarget) return;

                                const zone = dropTarget.closest('.drop-zone, .drop-zone-match, .drop-zone-blank');
                                let isValidZone = false;
                                for (let i = 0; i < dropZones.length; i++) {
                                    if (dropZones[i] === zone) {
                                        isValidZone = true;
                                        break;
                                    }
                                }

                                if (isValidZone) {
                                    const data = item.dataset[sourceDataAttr];
                                    zone.innerHTML = `<span class="text-gray-800 font-medium">${data}</span>`;
                                    zone.classList.add('filled');
                                    if (targetDataAttr === 'matched') {
                                        zone.dataset.matched = data;
                                    } else {
                                        zone.dataset.answer = data;
                                    }
                                }
                            });
                        });
                    }

        // Setup drag and drop functionality
        function setupDragAndDrop() {
                        const dragItems = document.querySelectorAll('.drag-item');
                        const dropZones = document.querySelectorAll('.drop-zone');

                        enableTouchDrag(dragItems, dropZones, 'option', 'answer');

                        dragItems.forEach(item => {
                            item.addEventListener('dragstart', (e) => {
                                e.dataTransfer.setData('text/plain', e.target.dataset.option);
                                e.target.style.opacity = '0.5';
                            });

                            item.addEventListener('dragend', (e) => {
                                e.target.style.opacity = '1';
                            });
                        });

                        dropZones.forEach(zone => {
                            zone.addEventListener('dragover', (e) => {
                                e.preventDefault();
                                zone.classList.add('drag-over');
                            });

                            zone.addEventListener('dragleave', () => {
                                zone.classList.remove('drag-over');
                            });

                            zone.addEventListener('drop', (e) => {
                                e.preventDefault();
                                const data = e.dataTransfer.getData('text/plain');
                                zone.innerHTML = `<span class="text-gray-800 font-medium">${data}</span>`;
                                zone.classList.remove('drag-over');
                                zone.classList.add('filled');
                                zone.dataset.answer = data;
                            });
                        });
                    }

        // Setup matching drag and drop functionality
        function setupMatchingDragAndDrop() {
                        const dragItems = document.querySelectorAll('.drag-item');
                        const dropZones = document.querySelectorAll('.drop-zone-match');

                        enableTouchDrag(dragItems, dropZones, 'match', 'matched');

                        dragItems.forEach(item => {
                            item.addEventListener('dragstart', (e) => {
                                e.dataTransfer.setData('text/plain', e.target.dataset.match);
                                e.target.style.opacity = '0.5';
                            });

                            item.addEventListener('dragend', (e) => {
                                e.target.style.opacity = '1';
                            });
                        });

                        dropZones.forEach(zone => {
                            zone.addEventListener('dragover', (e) => {
                                e.preventDefault();
                                zone.classList.add('drag-over');
                            });

                            zone.addEventListener('dragleave', () => {
                                zone.classList.remove('drag-over');
                            });

                            zone.addEventListener('drop', (e) => {
                                e.preventDefault();
                                const data = e.dataTransfer.getData('text/plain');
                                zone.innerHTML = `<span class="text-gray-800 font-medium">${data}</span>`;
                                zone.classList.remove('drag-over');
                                zone.classList.add('filled');
                                zone.dataset.matched = data;
                            });
                        });
                    }

        // Setup fill blanks drag and drop functionality
        function setupFillBlanksDragAndDrop() {
                        const dragItems = document.querySelectorAll('.drag-item');
                        const dropZones = document.querySelectorAll('.drop-zone-blank');

                        enableTouchDrag(dragItems, dropZones, 'option', 'answer');

                        dragItems.forEach(item => {
                            item.addEventListener('dragstart', (e) => {
                                e.dataTransfer.setData('text/plain', e.target.dataset.option);
                                e.target.style.opacity = '0.5';
                            });

                            item.addEventListener('dragend', (e) => {
                                e.target.style.opacity = '1';
                            });
                        });

                        dropZones.forEach(zone => {
                            zone.addEventListener('dragover', (e) => {
                                e.preventDefault();
                                zone.classList.add('drag-over');
                            });

                            zone.addEventListener('dragleave', () => {
                                zone.classList.remove('drag-over');
                            });

                            zone.addEventListener('drop', (e) => {
                                e.preventDefault();
                                const data = e.dataTransfer.getData('text/plain');
                                zone.innerHTML = `<span class="text-gray-800 font-medium">${data}</span>`;
                                zone.classList.remove('drag-over');
                                zone.classList.add('filled');
                                zone.dataset.answer = data;
                            });
                        });
                    }

        // Load previous answer
        function loadPreviousAnswer() {
                        const answer = userAnswers[currentQuestionIndex];
                        if (!answer) return;

                        const question = currentQuestions[currentQuestionIndex];

                        if (question.type === 'multiple') {
                            if (question.multiSelect) {
                                answer.forEach(index => {
                                    const checkbox = document.querySelector(`input[name="q${currentQuestionIndex}_${index}"]`);
                                    if (checkbox) checkbox.checked = true;
                                });
                            } else {
                                const radio = document.querySelector(`input[name="q${currentQuestionIndex}"][value="${answer[0]}"]`);
                                if (radio) radio.checked = true;
                            }
                        } else if (question.type === 'truefalse') {
                            const radio = document.querySelector(`input[name="q${currentQuestionIndex}"][value="${answer}"]`);
                            if (radio) radio.checked = true;
                        } else if (question.type === 'drag') {
                            answer.forEach((ans, index) => {
                                const dropZone = document.querySelector(`[data-blank="${index}"]`);
                                if (dropZone && ans) {
                                    dropZone.innerHTML = `<span class="text-gray-800 font-medium">${ans}</span>`;
                                    dropZone.classList.add('filled');
                                    dropZone.dataset.answer = ans;
                                }
                            });
                        } else if (question.type === 'shortanswer') {
                            const textarea = document.getElementById('shortAnswer');
                            if (textarea) textarea.value = answer || '';
                        } else if (question.type === 'fillblanks') {
                            if (answer) {
                                answer.forEach((ans, index) => {
                                    const dropZone = document.querySelector(`[data-blank="${index}"]`);
                                    if (dropZone && ans) {
                                        dropZone.innerHTML = `<span class="text-gray-800 font-medium">${ans}</span>`;
                                        dropZone.classList.add('filled');
                                        dropZone.dataset.answer = ans;
                                    }
                                });
                            }
                        } else if (question.type === 'matching') {
                            if (answer) {
                                Object.keys(answer).forEach(key => {
                                    const dropZone = document.querySelector(`[data-answer="${key}"]`);
                                    if (dropZone && answer[key]) {
                                        dropZone.innerHTML = `<span class="text-gray-800 font-medium">${answer[key]}</span>`;
                                        dropZone.classList.add('filled');
                                        dropZone.dataset.matched = answer[key];
                                    }
                                });
                            }
                        }
                    }

        // Save current answer
        function saveCurrentAnswer() {
                        const question = currentQuestions[currentQuestionIndex];
                        let answer = null;

                        if (question.type === 'multiple') {
                            if (question.multiSelect) {
                                answer = [];
                                question.options.forEach((_, index) => {
                                    const checkbox = document.querySelector(`input[name="q${currentQuestionIndex}_${index}"]`);
                                    if (checkbox && checkbox.checked) {
                                        answer.push(index);
                                    }
                                });
                            } else {
                                const radio = document.querySelector(`input[name="q${currentQuestionIndex}"]:checked`);
                                answer = radio ? [parseInt(radio.value)] : null;
                            }
                        } else if (question.type === 'truefalse') {
                            const radio = document.querySelector(`input[name="q${currentQuestionIndex}"]:checked`);
                            answer = radio ? (radio.value === 'true') : null;
                        } else if (question.type === 'drag') {
                            answer = [];
                            question.blanks.forEach((_, index) => {
                                const dropZone = document.querySelector(`[data-blank="${index}"]`);
                                answer.push(dropZone ? dropZone.dataset.answer || null : null);
                            });
                        } else if (question.type === 'shortanswer') {
                            const textarea = document.getElementById('shortAnswer');
                            answer = textarea ? textarea.value : '';
                        } else if (question.type === 'fillblanks') {
                            answer = [];
                            question.blanks.forEach((_, index) => {
                                const dropZone = document.querySelector(`[data-blank="${index}"]`);
                                answer.push(dropZone ? dropZone.dataset.answer || null : null);
                            });
                        } else if (question.type === 'matching') {
                            answer = {};
                            const dropZones = document.querySelectorAll('.drop-zone-match');
                            dropZones.forEach(zone => {
                                const correctAnswer = zone.dataset.answer;
                                const matchedItem = zone.dataset.matched;
                                if (correctAnswer && matchedItem) {
                                    answer[correctAnswer] = matchedItem;
                                }
                            });
                        }

                        userAnswers[currentQuestionIndex] = answer;
                    }

        // Update navigation buttons
        function updateNavigationButtons() {
                        const prevBtn = document.getElementById('prevBtn');
                        const nextBtn = document.getElementById('nextBtn');
                        const submitBtn = document.getElementById('submitBtn');

                        prevBtn.disabled = currentQuestionIndex === 0;

                        if (currentQuestionIndex === currentQuestions.length - 1) {
                            nextBtn.classList.add('hidden');
                            submitBtn.classList.remove('hidden');
                        } else {
                            nextBtn.classList.remove('hidden');
                            submitBtn.classList.add('hidden');
                        }
                    }

        // Navigation functions
        function previousQuestion() {
                        if (currentQuestionIndex > 0) {
                            saveCurrentAnswer();
                            currentQuestionIndex--;
                            updateProgress();
                            displayQuestion();
                        }
                    }

        function nextQuestion() {
                        if (currentQuestionIndex < currentQuestions.length - 1) {
                            saveCurrentAnswer();
                            currentQuestionIndex++;
                            updateProgress();
                            displayQuestion();
                        }
                    }

        // Submit quiz
        function submitQuiz() {
                        saveCurrentAnswer();
                        calculateScore();
                        showResults();
                    }

        // Calculate score for all question types
        function calculateScore() {
                        score = 0;
                        mistakes = []; // Reset mistakes for current section

                        currentQuestions.forEach((question, index) => {
                            const userAnswer = userAnswers[index];
                            let isCorrect = false;
                            let correctAnswer = '';
                            let userAnswerText = '';

                            if (question.type === 'multiple') {
                                if (question.multiSelect) {
                                    if (userAnswer && userAnswer.length === question.correct.length) {
                                        isCorrect = question.correct.every(correct => userAnswer.includes(correct));
                                    }
                                    correctAnswer = question.correct.map(i => `${String.fromCharCode(65 + i)}. ${question.options[i]}`).join(', ');
                                    userAnswerText = userAnswer ? userAnswer.map(i => `${String.fromCharCode(65 + i)}. ${question.options[i]}`).join(', ') : 'Tiada jawapan';
                                } else {
                                    if (userAnswer && userAnswer[0] === question.correct[0]) {
                                        isCorrect = true;
                                    }
                                    correctAnswer = `${String.fromCharCode(65 + question.correct[0])}. ${question.options[question.correct[0]]}`;
                                    userAnswerText = userAnswer ? `${String.fromCharCode(65 + userAnswer[0])}. ${question.options[userAnswer[0]]}` : 'Tiada jawapan';
                                }
                                if (isCorrect) score++;
                            } else if (question.type === 'truefalse') {
                                isCorrect = userAnswer === question.correct;
                                correctAnswer = question.correct ? 'BETUL' : 'SALAH';
                                userAnswerText = userAnswer === true ? 'BETUL' : userAnswer === false ? 'SALAH' : 'Tiada jawapan';
                                if (isCorrect) score++;
                            } else if (question.type === 'drag') {
                                if (userAnswer) {
                                    isCorrect = question.blanks.every((blank, i) => userAnswer[i] === blank);
                                }
                                correctAnswer = question.blanks.join(', ');
                                userAnswerText = userAnswer ? userAnswer.join(', ') : 'Tiada jawapan';
                                if (isCorrect) score++;
                            } else if (question.type === 'fillblanks') {
                                if (userAnswer) {
                                    let correctCount = 0;
                                    question.blanks.forEach((blank, i) => {
                                        if (userAnswer[i] === blank.answer) {
                                            correctCount++;
                                        }
                                    });
                                    const partialScore = Math.round((correctCount / question.blanks.length) * question.points);
                                    score += partialScore;
                                    isCorrect = correctCount === question.blanks.length;
                                }
                                correctAnswer = question.blanks.map(b => b.answer).join(', ');
                                userAnswerText = userAnswer ? userAnswer.join(', ') : 'Tiada jawapan';
                            } else if (question.type === 'matching') {
                                if (userAnswer) {
                                    let correctCount = 0;
                                    question.pairs.forEach(pair => {
                                        if (userAnswer[pair.right] === pair.left) {
                                            correctCount++;
                                        }
                                    });
                                    const partialScore = Math.round((correctCount / question.pairs.length) * question.points);
                                    score += partialScore;
                                    isCorrect = correctCount === question.pairs.length;
                                }
                                correctAnswer = question.pairs.map(p => `${p.left} ‚Üí ${p.right}`).join(', ');
                                userAnswerText = userAnswer ? Object.keys(userAnswer).map(k => `${userAnswer[k]} ‚Üí ${k}`).join(', ') : 'Tiada jawapan';
                            } else if (question.type === 'shortanswer') {
                                if (userAnswer && userAnswer.trim()) {
                                    const answerResult = scoreShortAnswer(question, userAnswer);

                                    // Handle both simple scoring (returns number) and AI scoring (returns object)
                                    if (typeof answerResult === 'object') {
                                        score += answerResult.score;
                                        isCorrect = answerResult.score === question.points;

                                        // Store AI analysis for display
                                        if (!window.aiAnalysis) window.aiAnalysis = {};
                                        window.aiAnalysis[index] = answerResult;
                                    } else {
                                        score += answerResult;
                                        isCorrect = answerResult === question.points;
                                    }
                                }
                                correctAnswer = 'Jawapan terbuka (semak dengan guru)';
                                userAnswerText = userAnswer || 'Tiada jawapan';
                            }

                            // Track mistakes
                            if (!isCorrect) {
                                mistakes.push({
                                    questionNumber: index + 1,
                                    question: question.question,
                                    userAnswer: userAnswerText,
                                    correctAnswer: correctAnswer,
                                    section: currentSection
                                });
                            }
                        });
                    }

        // Advanced AI-powered scoring for KBAT questions
        function scoreShortAnswer(question, userAnswer) {
                        const normalizedAnswer = userAnswer.toLowerCase()
                            .replace(/[^\w\s]/g, ' ')
                            .replace(/\s+/g, ' ')
                            .trim();

                        if (question.scoring === 'simple') {
                            // Simple keyword matching for question (a)
                            const foundKeywords = question.keywords.filter(keyword =>
                                normalizedAnswer.includes(keyword.toLowerCase())
                            );
                            return foundKeywords.length >= 2 ? question.points :
                                foundKeywords.length === 1 ? Math.floor(question.points / 2) : 0;
                        } else if (question.scoring === 'weighted') {
                            // Advanced AI scoring for KBAT questions
                            return scoreKBATAnswer(question, normalizedAnswer, userAnswer);
                        } else if (question.scoring === 'countries') {
                            // Country matching for question 2(a)
                            const foundCountries = question.keywords.filter(country =>
                                normalizedAnswer.includes(country.toLowerCase())
                            );
                            return foundCountries.length >= 2 ? question.points :
                                foundCountries.length === 1 ? Math.floor(question.points / 2) : 0;
                        }

                        return 0;
                    }

        // Advanced KBAT Answer Scoring with AI-like analysis
        function scoreKBATAnswer(question, normalizedAnswer, originalAnswer) {
                        const maxScore = question.points;

                        // Check minimum answer length
                        const wordCount = originalAnswer.trim().split(/\s+/).length;
                        if (wordCount < 3) {
                            return {
                                score: 0,
                                status: "‚ùå",
                                feedback: "Jawapan terlalu pendek. Sila berikan penjelasan yang lebih lengkap.",
                                analysis: generateKBATAnalysis(question, originalAnswer, 0, maxScore)
                            };
                        }

                        // Use intelligent KBAT evaluation
                        return evaluateKBATAnswer(question, originalAnswer, normalizedAnswer);
                    }

        // Intelligent KBAT Answer Evaluation
        function evaluateKBATAnswer(question, originalAnswer, normalizedAnswer) {
                        const maxScore = question.points;

                        // Define reference answers and scoring patterns for each question
                        const kbatPatterns = {
                            // Question 1(b): Why respect other religions?
                            'kenapa kita perlu menghormati agama lain': {
                                patterns: [
                                    {
                                        concepts: ['perpaduan', 'bersatu', 'harmoni', 'keharmonian', 'rukun', 'damai', 'aman'],
                                        weight: 1,
                                        description: 'Perpaduan dan Keharmonian'
                                    },
                                    {
                                        concepts: ['toleransi', 'hormat', 'menghormati', 'saling menghargai', 'bertolak ansur', 'faham memahami'],
                                        weight: 1,
                                        description: 'Sikap Toleransi dan Hormat-menghormati'
                                    },
                                    {
                                        concepts: ['elak', 'mengelak', 'hindari', 'mencegah', 'konflik', 'pergaduhan', 'masalah', 'ketegangan'],
                                        weight: 1,
                                        description: 'Mengelakkan Konflik'
                                    }
                                ]
                            },
                            // Question 2(b): Language month activities
                            'aktiviti yang boleh dilaksanakan sempena sambutan bulan bahasa': {
                                patterns: [
                                    {
                                        concepts: ['pertandingan', 'pidato', 'bercerita', 'sajak', 'deklamasi', 'puisi'],
                                        weight: 1,
                                        description: 'Pertandingan Lisan (Pidato/Sajak/Bercerita)'
                                    },
                                    {
                                        concepts: ['drama', 'persembahan', 'teater', 'lakonan'],
                                        weight: 1,
                                        description: 'Persembahan Drama/Teater'
                                    },
                                    {
                                        concepts: ['menulis', 'karangan', 'esei', 'kuiz', 'aktiviti', 'interaktif', 'permainan bahasa'],
                                        weight: 1,
                                        description: 'Aktiviti Penulisan dan Interaktif'
                                    }
                                ]
                            }
                        };

                        // Find matching pattern based on question content
                        let matchedPattern = null;
                        const questionLower = question.question.toLowerCase();

                        for (const [key, pattern] of Object.entries(kbatPatterns)) {
                            if (questionLower.includes(key)) {
                                matchedPattern = pattern;
                                break;
                            }
                        }

                        if (!matchedPattern) {
                            // Fallback to original keyword matching
                            return fallbackKBATScoring(question, originalAnswer, normalizedAnswer);
                        }

                        // Evaluate answer against patterns
                        let totalScore = 0;
                        let foundConcepts = [];
                        let missedConcepts = [];

                        matchedPattern.patterns.forEach(pattern => {
                            let conceptFound = false;
                            let foundInThisPattern = [];

                            pattern.concepts.forEach(concept => {
                                if (normalizedAnswer.includes(concept.toLowerCase())) {
                                    conceptFound = true;
                                    foundInThisPattern.push(concept);
                                }
                            });

                            if (conceptFound) {
                                totalScore += pattern.weight;
                                foundConcepts.push({
                                    description: pattern.description,
                                    concepts: foundInThisPattern
                                });
                            } else {
                                missedConcepts.push(pattern.description);
                            }
                        });

                        // Determine status and feedback
                        let status, feedback;
                        const percentage = (totalScore / maxScore) * 100;

                        if (percentage >= 80) {
                            status = "‚úÖ";
                            feedback = `Jawapan cemerlang! Menunjukkan kefahaman yang mendalam tentang topik ini.`;
                        } else if (percentage >= 50) {
                            status = "‚ö†Ô∏è";
                            feedback = `Jawapan baik tetapi boleh diperbaiki.Cuba tambah: ${missedConcepts.slice(0, 2).join(', ')}.`;
                        } else {
                            status = "‚ùå";
                            feedback = `Jawapan perlu diperbaiki.Fokus pada: ${missedConcepts.slice(0, 2).join(', ')}.`;
                        }

                        return {
                            score: Math.min(totalScore, maxScore),
                            status: status,
                            feedback: feedback,
                            analysis: generateKBATAnalysis(question, originalAnswer, totalScore, maxScore, foundConcepts, missedConcepts)
                        };
                    }

        // Fallback scoring for questions without specific patterns
        function fallbackKBATScoring(question, originalAnswer, normalizedAnswer) {
                        let totalScore = 0;
                        const maxScore = question.points;
                        let feedback = [];

                        // Use original keyword matching as fallback
                        if (question.keywords && typeof question.keywords === 'object') {
                            Object.keys(question.keywords).forEach(category => {
                                const categoryData = question.keywords[category];
                                let categoryFound = false;

                                if (categoryData.words) {
                                    categoryData.words.forEach(word => {
                                        if (normalizedAnswer.includes(word.toLowerCase())) {
                                            categoryFound = true;
                                        }
                                    });
                                }

                                if (categoryFound) {
                                    totalScore += categoryData.weight || 1;
                                    feedback.push(`‚úî ${category}`);
                                } else {
                                    feedback.push(`‚úó ${category}`);
                                }
                            });
                        }

                        const percentage = (totalScore / maxScore) * 100;
                        let status = percentage >= 80 ? "‚úÖ" : percentage >= 50 ? "‚ö†Ô∏è" : "‚ùå";

                        return {
                            score: Math.min(totalScore, maxScore),
                            status: status,
                            feedback: feedback.join(', '),
                            analysis: generateKBATAnalysis(question, originalAnswer, totalScore, maxScore)
                        };
                    }

        // Generate detailed KBAT analysis
        function generateKBATAnalysis(question, answer, score, maxScore, foundConcepts = [], missedConcepts = []) {
                        const percentage = Math.round((score / maxScore) * 100);
                        const wordCount = answer.trim().split(/\s+/).length;

                        let analysis = `
                <div class="mt-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
                    <h6 class="font-bold text-blue-800 mb-3">ü§ñ Analisis Penilai Automatik KBAT</h6>
                    <div class="text-sm text-blue-700 space-y-2">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <p><strong>Markah:</strong> ${score}/${maxScore}</p>
                                <p><strong>Peratusan:</strong> ${percentage}%</p>
                            </div>
                            <div>
                                <p><strong>Panjang:</strong> ${wordCount} perkataan</p>
                                <p><strong>Status:</strong> ${percentage >= 80 ? '‚úÖ Cemerlang' : percentage >= 50 ? '‚ö†Ô∏è Baik' : '‚ùå Perlu Diperbaiki'}</p>
                            </div>
                        </div>
            `;

                        if (foundConcepts.length > 0) {
                            analysis += `
                        <div class="mt-3">
                            <p class="font-medium text-green-800">‚úÖ Konsep yang dijumpai:</p>
                            <ul class="list-disc list-inside ml-4 text-green-700">
                `;
                            foundConcepts.forEach(concept => {
                                analysis += `<li>${concept.description}</li>`;
                            });
                            analysis += `</ul></div>`;
                        }

                        if (missedConcepts.length > 0) {
                            analysis += `
                        <div class="mt-3">
                            <p class="font-medium text-orange-800">‚ö†Ô∏è Konsep yang boleh ditambah:</p>
                            <ul class="list-disc list-inside ml-4 text-orange-700">
                `;
                            missedConcepts.forEach(concept => {
                                analysis += `<li>${concept}</li>`;
                            });
                            analysis += `</ul></div>`;
                        }

                        analysis += `
                    </div>
                </div>
            `;

                        return analysis;
                    }

        // Show results
        function showResults() {
                        // Store section score and mark as completed
                        sectionScores[currentSection].score = score;
                        if (!completedSections.includes(currentSection)) {
                            completedSections.push(currentSection);
                        }

                        document.getElementById('quizContainer').classList.add('hidden');
                        document.getElementById('resultsContainer').classList.remove('hidden');

                        const scoreDisplay = document.getElementById('scoreDisplay');

                        // Calculate total score across all completed sections
                        totalScore = sectionScores.A.score + sectionScores.B.score + sectionScores.C.score;
                        maxScore = sectionScores.A.max + sectionScores.B.max + sectionScores.C.max;
                        const percentage = Math.round((totalScore / maxScore) * 100);

                        scoreDisplay.innerHTML = `
                <div class="bg-blue-50 p-6 rounded-lg mb-6">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">Maklumat Murid</h3>
                    <p><strong>Nama:</strong> ${studentInfo.name}</p>
                    <p><strong>Kelas:</strong> ${studentInfo.class}</p>
                    <p><strong>Sekolah:</strong> ${studentInfo.school}</p>
                    
                    <!-- Results Watermark -->
                    <div class="mt-4 pt-4 border-t border-blue-200">
                        <div class="flex items-center justify-center space-x-2 text-xs text-blue-700">
                            <span>üìù≈† Sistem Kuiz oleh</span>
                            <a href="https://www.cikguaime.com/" target="_blank" rel="noopener noreferrer" 
                               class="font-semibold text-teal-600 hover:text-teal-800 transition-colors duration-300">
                                CikguAime
                            </a>
                        </div>
                    </div>
                </div>
                
                <div class="text-center mb-6">
                    <div class="text-3xl font-bold text-emerald-600 mb-2">Bahagian ${currentSection}: ${score}/${currentSection === 'A' ? 30 : 10}</div>
                    <div class="text-base sm:text-lg text-gray-700">Peratusan: ${Math.round((score / (currentSection === 'A' ? 30 : 10)) * 100)}%</div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="bg-green-50 p-4 rounded-lg text-center ${completedSections.includes('A') ? '' : 'opacity-50'}">
                        <h4 class="font-bold text-green-800">Bahagian A</h4>
                        <p class="text-2xl font-bold text-green-600">${sectionScores.A.score}/${sectionScores.A.max}</p>
                        <p class="text-sm text-green-700">${Math.round((sectionScores.A.score / sectionScores.A.max) * 100)}%</p>
                    </div>
                    <div class="bg-blue-50 p-4 rounded-lg text-center ${completedSections.includes('B') ? '' : 'opacity-50'}">
                        <h4 class="font-bold text-blue-800">Bahagian B</h4>
                        <p class="text-2xl font-bold text-blue-600">${sectionScores.B.score}/${sectionScores.B.max}</p>
                        <p class="text-sm text-blue-700">${Math.round((sectionScores.B.score / sectionScores.B.max) * 100)}%</p>
                    </div>
                    <div class="bg-teal-50 p-4 rounded-lg text-center ${completedSections.includes('C') ? '' : 'opacity-50'}">
                        <h4 class="font-bold text-teal-800">Bahagian C</h4>
                        <p class="text-2xl font-bold text-teal-600">${sectionScores.C.score}/${sectionScores.C.max}</p>
                        <p class="text-sm text-teal-700">${Math.round((sectionScores.C.score / sectionScores.C.max) * 100)}%</p>
                    </div>
                </div>
            `;

                        // Show appropriate buttons
                        const nextSectionButton = document.getElementById('nextSectionButton');
                        const nextSectionText = document.getElementById('nextSectionText');
                        const reviewMistakes = document.getElementById('reviewMistakes');

                        // Show next section button if not all sections completed
                        if (currentSection === 'A' && !completedSections.includes('B')) {
                            nextSectionButton.classList.remove('hidden');
                            nextSectionText.textContent = 'Teruskan ke Bahagian B';
                        } else if (currentSection === 'B' && !completedSections.includes('C')) {
                            nextSectionButton.classList.remove('hidden');
                            nextSectionText.textContent = 'Teruskan ke Bahagian C';
                        } else {
                            nextSectionButton.classList.add('hidden');
                            // Show final results if all sections completed
                            if (completedSections.length === 3) {
                                scoreDisplay.innerHTML += `
                        <div class="text-center mb-6 p-6 bg-gradient-to-r from-green-100 to-blue-100 rounded-lg">
                            <h3 class="text-xl sm:text-2xl font-bold text-gray-800 mb-3 sm:mb-4">üéâ KUIZ SELESAI! üéâ</h3>
                            <div class="text-4xl font-bold text-emerald-600 mb-2">Jumlah: ${totalScore}/${maxScore}</div>
                            <div class="text-2xl text-gray-700 mb-4">Peratusan Keseluruhan: ${percentage}%</div>
                            <div class="text-lg ${percentage >= 80 ? 'text-green-600' : percentage >= 60 ? 'text-blue-600' : percentage >= 40 ? 'text-yellow-600' : 'text-red-600'}">
                                Gred: ${percentage >= 80 ? 'A - Cemerlang' : percentage >= 60 ? 'B - Baik' : percentage >= 40 ? 'C - Memuaskan' : 'D - Perlu Diperbaiki'}
                            </div>
                            
                            <!-- Leaderboard Button for Completed Quiz -->
                            <div class="mt-6">
                                <button onclick="showLeaderboard()" class="bg-gradient-to-r from-yellow-500 to-orange-500 hover:from-yellow-600 hover:to-orange-600 text-white font-bold py-2 sm:py-3 px-4 sm:px-6 rounded-xl transform hover:scale-105 transition-all duration-300 shadow-lg hover-lift text-sm sm:text-base">
                                    üèÜ Lihat Papan Pendahulu
                                </button>
                            </div>
                            
                            <!-- Final Results Watermark -->
                            <div class="mt-6 pt-4 border-t border-gray-300">
                                <div class="flex items-center justify-center space-x-2 text-sm text-gray-600">
                                    <span>üèÜ Sistem Penilaian Automatik oleh</span>
                                    <a href="https://www.cikguaime.com/" target="_blank" rel="noopener noreferrer"
                                       class="font-bold text-teal-600 hover:text-teal-800 transition-colors duration-300">
                                        CikguAime
                                    </a>
                                </div>
                            </div>
                        </div>
                    `;
                                // Submit to Google Sheets
                                submitToGoogleSheets();
                            }
                        }

                        // Show mistake review button if there are mistakes
                        if (mistakes.length > 0) {
                            reviewMistakes.classList.remove('hidden');
                        } else {
                            reviewMistakes.classList.add('hidden');
                        }

                        // Show teacher answers button for section C only
                        const showTeacherAnswers = document.getElementById('showTeacherAnswers');
                        if (currentSection === 'C') {
                            showTeacherAnswers.classList.remove('hidden');
                        } else {
                            showTeacherAnswers.classList.add('hidden');
                        }
                    }

        // Restart quiz
        function restartQuiz() {
                        currentSection = 'A';
                        currentQuestionIndex = 0;
                        score = 0;
                        userAnswers = [];
                        mistakes = [];
                        completedSections = [];
                        sectionScores = {
                            A: { score: 0, max: 30 },
                            B: { score: 0, max: 10 },
                            C: { score: 0, max: 10 }
                        };

                        document.getElementById('resultsContainer').classList.add('hidden');
                        document.getElementById('mainMenu').classList.remove('hidden');
                    }

        // Back to menu
        function backToMenu() {
                        document.getElementById('resultsContainer').classList.add('hidden');
                        document.getElementById('mainMenu').classList.remove('hidden');
                    }

        // Go to next section
        function goToNextSection() {
                        if (currentSection === 'A') {
                            startSection('B');
                        } else if (currentSection === 'B') {
                            startSection('C');
                        }
                    }

        // Show mistake review
        function showMistakeReview() {
                        const reviewContainer = document.getElementById('mistakeReviewContainer');
                        const reviewContent = document.getElementById('mistakesList');

                        let html = '';
                        mistakes.forEach(mistake => {
                            html += `
                    <div class="mb-6 p-4 bg-red-50 rounded-lg border border-red-200">
                        <p class="font-bold text-red-800 mb-2">Soalan ${mistake.questionNumber} (Bahagian ${mistake.section})</p>
                        <p class="text-gray-800 mb-3">${mistake.question}</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-white p-3 rounded border border-red-100">
                                <p class="text-xs text-gray-500 uppercase font-bold mb-1">Jawapan Anda:</p>
                                <p class="text-red-600">${mistake.userAnswer}</p>
                            </div>
                            <div class="bg-white p-3 rounded border border-green-100">
                                <p class="text-xs text-gray-500 uppercase font-bold mb-1">Jawapan Sebenar:</p>
                                <p class="text-green-600">${mistake.correctAnswer}</p>
                            </div>
                        </div>
                    </div>
                `;
                        });

                        reviewContent.innerHTML = html;
                        reviewContainer.classList.remove('hidden');
                    }

        // Close mistake review
        function closeMistakeReview() {
                        document.getElementById('mistakeReviewContainer').classList.add('hidden');
                    }

        // Submit to Google Sheets
        function submitToGoogleSheets() {
                        // Show loading state
                        const submitBtn = document.querySelector('button[onclick="submitQuiz()"]');
                        if (submitBtn) {
                            submitBtn.textContent = 'Sedang Menghantar...';
                            submitBtn.disabled = true;
                        }

                        // Prepare data
                        const timestamp = new Date().toISOString();
                        const totalScore = sectionScores.A.score + sectionScores.B.score + sectionScores.C.score;
                        const maxScore = sectionScores.A.max + sectionScores.B.max + sectionScores.C.max;

                        // Format AI Analysis for storage
                        let aiAnalysisText = '';
                        if (window.aiAnalysis) {
                            aiAnalysisText = JSON.stringify(window.aiAnalysis);
                        }

                        const formData = {
                            timestamp: timestamp,
                            name: studentInfo.name,
                            class: studentInfo.class,
                            school: studentInfo.school,
                            scoreA: sectionScores.A.score,
                            scoreB: sectionScores.B.score,
                            scoreC: sectionScores.C.score,
                            totalScore: totalScore,
                            maxScore: maxScore,
                            percentage: Math.round((totalScore / maxScore) * 100),
                            aiAnalysis: aiAnalysisText
                        };

                        console.log('Submitting data:', formData);

                        // Try multiple submission methods for robustness
                        submitViaGET(formData)
                            .then(() => showSubmissionSuccess())
                            .catch(error => {
                                console.warn('GET submission failed, trying iframe...', error);
                                submitViaIframe(formData);
                            });
                    }

        // Method 1: GET Request (Simple and often works without CORS if script is set up right)
        function submitViaGET(data) {
                        return new Promise((resolve, reject) => {
                            const params = new URLSearchParams(data).toString();
                            const url = `${GOOGLE_SHEETS_URL}?${params}`;

                            fetch(url, {
                                method: 'GET',
                                mode: 'no-cors', // Important for Google Apps Script
                                headers: {
                                    'Content-Type': 'application/x-www-form-urlencoded',
                                }
                            })
                                .then(response => {
                                    // With no-cors, we can't check response.ok
                                    // We assume success if no network error
                                    console.log('GET request sent successfully');
                                    resolve();
                                })
                                .catch(error => {
                                    console.error('GET request failed:', error);
                                    reject(error);
                                });
                        });
                    }

        // Method 2: Hidden Iframe (Old school but reliable fallback)
        function submitViaIframe(data) {
                        const iframeId = 'submission-iframe';
                        let iframe = document.getElementById(iframeId);

                        if (!iframe) {
                            iframe = document.createElement('iframe');
                            iframe.id = iframeId;
                            iframe.style.display = 'none';
                            document.body.appendChild(iframe);
                        }

                        const params = new URLSearchParams(data).toString();
                        const url = `${GOOGLE_SHEETS_URL}?${params}`;

                        iframe.src = url;

                        // Assume success after a delay since we can't read iframe content due to same-origin policy
                        setTimeout(() => {
                            showSubmissionSuccess();
                        }, 2000);
                    }

        // Method 3: Script Tag (JSONP style - backup)
        function submitViaScript(data) {
                        const params = new URLSearchParams(data).toString();
                        const script = document.createElement('script');
                        script.src = `${GOOGLE_SHEETS_URL}?${params}&callback=handleSubmissionResponse`;
                        document.body.appendChild(script);
                    }

        // Show data for manual copy if all else fails
        function showDataForCopy(data) {
                        const dataStr = `Nama: ${data.name}\nKelas: ${data.class}\nSekolah: ${data.school}\nMarkah: ${data.totalScore}/${data.maxScore} (${data.percentage}%)`;

                        const container = document.createElement('div');
                        container.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                        container.innerHTML = `
                <div class="bg-white p-6 rounded-lg max-w-md w-full mx-4">
                    <h3 class="text-lg sm:text-xl font-bold text-gray-800 mb-4">Masalah Penghantaran</h3>
                    <p class="text-gray-600 mb-4">Maaf, terdapat masalah menghantar keputusan secara automatik. Sila salin keputusan ini dan hantar kepada guru anda:</p>
                    <textarea class="w-full h-32 p-3 border rounded mb-4 font-mono text-sm" readonly>${dataStr}</textarea>
                    <div class="flex justify-end space-x-3">
                        <button onclick="copyToClipboard(this)" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Salin</button>
                        <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300">Tutup</button>
                    </div>
                </div>
            `;
                        document.body.appendChild(container);
                    }

        function copyToClipboard(btn) {
                        const textarea = btn.parentElement.previousElementSibling;
                        textarea.select();
                        document.execCommand('copy');
                        btn.textContent = 'Disalin!';
                        setTimeout(() => btn.textContent = 'Salin', 2000);
                    }

        function showSubmissionSuccess() {
                        const submitBtn = document.querySelector('button[onclick="submitQuiz()"]');
                        if (submitBtn) {
                            submitBtn.textContent = 'Berjaya Dihantar!';
                            submitBtn.classList.remove('bg-emerald-600', 'hover:bg-emerald-700');
                            submitBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                        }

                        // Show success message
                        const message = document.createElement('div');
                        message.className = 'fixed top-4 right-4 bg-green-100 border-l-4 border-green-500 text-green-700 p-4 rounded shadow-lg z-50 animate-fade-in-down';
                        message.innerHTML = `
                <div class="flex items-center">
                    <div class="text-2xl mr-3">‚úÖ</div>
                    <div>
                        <p class="font-bold">Berjaya!</p>
                        <p class="text-sm">Keputusan anda telah direkodkan.</p>
                    </div>
                </div>
            `;
                        document.body.appendChild(message);

                        setTimeout(() => {
                            message.remove();
                        }, 5000);
                    }

        function showSubmissionError(error) {
                        const submitBtn = document.querySelector('button[onclick="submitQuiz()"]');
                        if (submitBtn) {
                            submitBtn.textContent = 'Cuba Lagi';
                            submitBtn.disabled = false;
                        }

                        // Show error message with retry option
                        const message = document.createElement('div');
                        message.className = 'fixed top-4 right-4 bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded shadow-lg z-50 animate-fade-in-down';
                        message.innerHTML = `
                <div class="flex items-center">
                    <div class="text-2xl mr-3">‚ö†Ô∏è</div>
                    <div>
                        <p class="font-bold">Ralat Penghantaran</p>
                        <p class="text-sm">Gagal menghubungi pelayan.</p>
                        <button onclick="retrySubmission()" class="mt-2 text-sm font-bold underline hover:text-red-800">Cuba Lagi</button>
                    </div>
                </div>
            `;
                        document.body.appendChild(message);

                        setTimeout(() => {
                            message.remove();
                        }, 8000);
                    }

        function retrySubmission() {
                        submitToGoogleSheets();
                    }

        // Leaderboard Functions
        function showLeaderboard() {
                        const modal = document.getElementById('leaderboardContainer');
                        modal.classList.remove('hidden');
                        loadLeaderboard();
                    }

        function loadLeaderboard() {
                        const content = document.getElementById('leaderboardList');
                        content.innerHTML = `
                <div class="text-center py-8">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-emerald-600 mb-4"></div>
                    <p class="text-gray-600">Sedang memuatkan data...</p>
                </div>
            `;

                        // Use JSONP to bypass CORS
                        fetchLeaderboardJSONP();
                    }

        function fetchLeaderboardJSONP() {
                        // Create a unique callback name
                        const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());

                        // Define the callback function
                        window[callbackName] = function (data) {
                            delete window[callbackName];
                            document.body.removeChild(script);
                            displayLeaderboard(data);
                        };

                        // Create script tag
                        const script = document.createElement('script');
                        script.src = `${GOOGLE_SHEETS_URL}?action=getLeaderboard&callback=${callbackName}`;
                        script.onerror = function () {
                            delete window[callbackName];
                            document.body.removeChild(script);

                            // Fallback to fetch if JSONP fails (though fetch usually fails CORS)
                            fetch(`${GOOGLE_SHEETS_URL}?action=getLeaderboard`)
                                .then(response => response.json())
                                .then(data => displayLeaderboard(data))
                                .catch(error => {
                                    console.error('Error loading leaderboard:', error);
                                    document.getElementById('leaderboardList').innerHTML = `
                            <div class="text-center py-8 text-red-600">
                                <p class="font-bold mb-2">‚ö†Ô∏è Gagal Memuatkan Data</p>
                                <p class="text-sm">Sila pastikan sambungan internet anda stabil.</p>
                                <button onclick="refreshLeaderboard()" class="mt-4 px-4 py-2 bg-emerald-100 text-emerald-700 rounded hover:bg-emerald-200 transition-colors">
                                    Cuba Lagi
                                </button>
                            </div>
                        `;
                                });
                        };

                        document.head.appendChild(script);

                        // Timeout handler
                        setTimeout(() => {
                            if (window[callbackName]) {
                                console.warn('JSONP timeout');
                                // Cleanup is handled by onerror or success, but we can force error state here if needed
                            }
                        }, 15000);
                    }

        function displayLeaderboard(data) {
                        const content = document.getElementById('leaderboardList');

                        if (!data || data.length === 0) {
                            content.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <p>Belum ada rekod.</p>
                    </div>
                `;
                            return;
                        }

                        // Sort by score (descending)
                        data.sort((a, b) => b.totalScore - a.totalScore);

                        let html = '<div class="space-y-3">';

                        data.slice(0, 10).forEach((entry, index) => {
                            const rank = index + 1;
                            const isTop3 = rank <= 3;
                            const rankColor = rank === 1 ? 'bg-yellow-100 text-yellow-700 border-yellow-300' :
                                rank === 2 ? 'bg-gray-100 text-gray-700 border-gray-300' :
                                    rank === 3 ? 'bg-orange-100 text-orange-700 border-orange-300' :
                                        'bg-white text-gray-700 border-gray-200';

                            const medal = rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : `<span class="font-bold text-gray-500">#${rank}</span>`;

                            html += `
                    <div class="flex items-center p-3 rounded-lg border ${rankColor} ${isTop3 ? 'transform hover:scale-102 transition-transform shadow-sm' : ''}">
                        <div class="flex-shrink-0 w-10 text-center text-xl">${medal}</div>
                        <div class="flex-1 min-w-0 ml-2">
                            <p class="font-bold truncate">${entry.name}</p>
                            <p class="text-xs opacity-75 truncate">${entry.school}</p>
                        </div>
                        <div class="flex-shrink-0 text-right ml-2">
                            <p class="font-bold text-lg">${entry.totalScore}</p>
                            <p class="text-xs opacity-75">${entry.percentage}%</p>
                        </div>
                    </div>
                `;
                        });

                        html += '</div>';
                        content.innerHTML = html;
                    }

        function closeLeaderboard() {
                        document.getElementById('leaderboardContainer').classList.add('hidden');
                    }

        function refreshLeaderboard() {
                        loadLeaderboard();
                    }

        // Teacher Answers Functions
        function showTeacherAnswers() {
                        const modal = document.getElementById('teacherAnswersContainer');
                        const content = document.getElementById('teacherAnswersList');

                        let html = '<div class="space-y-6">';

                        currentQuestions.forEach((question, index) => {
                            html += `
                    <div class="bg-white p-4 rounded-lg border border-gray-200">
                        <div class="flex items-start mb-3">
                            <span class="inline-flex items-center justify-center h-8 w-8 rounded-full bg-emerald-100 text-emerald-800 font-bold text-sm mr-3">
                                ${index + 1}
                            </span>
                            <div class="flex-1">
                                <p class="text-gray-800 font-medium">${question.question}</p>
                            </div>
                        </div>
                        
                        <div class="ml-11 space-y-3">
                            <div class="bg-green-50 p-3 rounded border border-green-100">
                                <p class="text-xs text-green-800 font-bold uppercase mb-1">Jawapan Dicadangkan:</p>
                                <div class="text-green-700 text-sm">
                `;

                            // Format answer based on question type
                            if (question.type === 'shortanswer') {
                                if (question.scoring === 'simple' || question.scoring === 'countries') {
                                    html += `<ul class="list-disc list-inside">`;
                                    question.keywords.forEach(keyword => {
                                        html += `<li>${keyword}</li>`;
                                    });
                                    html += `</ul>`;
                                } else if (question.scoring === 'weighted') {
                                    html += `<p class="mb-2">Kata kunci/Konsep yang dicari:</p>`;
                                    // We don't have easy access to the patterns here without duplicating logic, 
                                    // so we'll show a generic message or the guidelines
                                    html += `<p>${question.guidelines}</p>`;
                                }
                            } else {
                                html += `<p>${question.guidelines || 'Rujuk skema pemarkahan.'}</p>`;
                            }

                            html += `
                                </div>
                            </div>
                            
                            <div class="bg-blue-50 p-3 rounded border border-blue-100">
                                <p class="text-xs text-blue-800 font-bold uppercase mb-1">Panduan Pemarkahan:</p>
                                <p class="text-blue-700 text-sm">${question.guidelines}</p>
                                <p class="text-blue-600 text-xs mt-1">Markah Penuh: ${question.points}</p>
                            </div>
                        </div>
                    </div>
                `;
                        });

                        html += '</div>';

                        content.innerHTML = html;
                        modal.classList.remove('hidden');
                    }

        function closeTeacherAnswers() {
                        document.getElementById('teacherAnswersContainer').classList.add('hidden');
                    }
    </script>

</body>

</html>
